<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <title>Hokkaido '26</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --fuji-teal: #2A4B55; --fuji-red: #B54B4B; --fuji-gold: #D4AF37; --text-dark: #1a1a1a;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --glass-blur: blur(20px);
            --slot-height: 70px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'M PLUS Rounded 1c', sans-serif !important; }
        body { margin: 0; padding: 0; color: var(--text-dark); padding-bottom: 140px; background: url('mailbox.png') no-repeat center center fixed; background-size: cover; min-height: 100vh; }
        
        /* GLASS UI CLASSES */
        .glass-panel { background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border: var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 24px; }
        
        .app-header { position: sticky; top: 10px; z-index: 1000; margin: 0 15px 15px 15px; padding: 12px; text-align: center; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 16px; box-shadow: var(--glass-shadow); }
        .app-title { font-size: 17px; font-weight: 800; color: var(--fuji-teal); letter-spacing: 0.5px; }
        
        .plan-sticky-header { position: sticky; top: 75px; z-index: 900; margin: 0 -10px; padding: 0 10px 5px 10px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        
        .dashboard-container { margin: 15px 15px; height: auto; min-height: 200px; border-radius: 24px; overflow: hidden; position: relative; background: url('tree.png') no-repeat center right; background-size: cover; color: var(--text-dark); border: 2px solid rgba(255,255,255,0.5); box-shadow: var(--glass-shadow); transition: 0.3s; }
        .dash-overlay { padding: 25px; display: flex; flex-direction: column; justify-content: space-between; min-height: 200px; gap: 15px; }
        .dash-content { display: flex; flex-direction: column; align-items: flex-start; max-width: 60%; }
        .dash-loc { font-size: 32px; font-weight: 800; color: #111; letter-spacing: 1px; line-height: 1.1; text-shadow: 0 2px 10px rgba(255,255,255,0.6); }
        .dash-sub { font-size: 28px; font-weight: 800; color: #111; margin-top: 5px; line-height: 1.2; text-shadow: 0 2px 10px rgba(255,255,255,0.6); }
        .dash-rate { background: rgba(255,255,255,0.9); padding: 10px 16px; border-radius: 14px; font-size: 15px; font-weight: 800; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: var(--fuji-teal); backdrop-filter: blur(10px); }
        .dash-map { display: none; width: 100%; height: 100%; border: none; min-height: 200px; }
        .close-map { position: absolute; top: 15px; right: 15px; background: var(--fuji-red); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight:bold; cursor: pointer; display: none; z-index: 50; }

        .date-strip { overflow-x: auto; white-space: nowrap; padding: 0 15px; margin-bottom: 10px; scrollbar-width: none; }
        .date-pill { display: inline-block; padding: 15px 20px; margin-right: 10px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 18px; color: #666; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; min-width: 110px; border: 1px solid rgba(255,255,255,0.3); }
        .date-pill.active { background: var(--fuji-teal); color: #fff; transform: scale(1.05); box-shadow: 0 8px 20px rgba(42, 75, 85, 0.3); }
        .d-wk { font-size: 14px; font-weight: 800; margin-bottom: 2px; }

        .hotel-bar { margin: 15px; padding: 18px; text-align: center; font-weight: 800; color: var(--fuji-teal); background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius: 20px; border: var(--glass-border); box-shadow: var(--glass-shadow); }
        .timeline-block { margin: 15px; padding: 20px 0; min-height: 500px; overflow: hidden; position: relative; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius: 24px; border: var(--glass-border); box-shadow: var(--glass-shadow); }
        .time-axis { position: absolute; left: 0; top: 20px; bottom: 20px; width: 90px; border-right: 2px dashed rgba(0,0,0,0.1); }
        .events-area { margin-left: 90px; position: relative; min-height: 100%; }
        .time-slot { height: var(--slot-height); position: relative; }
        .ts-label { position: absolute; right: 12px; top: -10px; font-size: 11px; font-weight:800; color: #666; background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 6px; }
        .sun-marker-axis { position: absolute; left: 5px; right: 5px; height: 1px; border-top: 2px dotted var(--fuji-gold); z-index: 5; pointer-events: none; }
        .sun-text-axis { position: absolute; left: 0; top: -18px; width: 100%; text-align: center; font-size: 9px; background: #fff; border-radius: 4px; color: var(--fuji-gold); font-weight: bold; padding: 1px; border: 1px solid var(--fuji-gold); }

        .t-event { position: absolute; left: 10px; right: 15px; background: rgba(244, 242, 233, 0.95); border-radius: 12px; padding: 8px 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); z-index: 10; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); }
        .t-event::before { content: ''; position: absolute; top: -5px; left: 8px; right: 8px; height: 8px; background: rgba(255,255,255,0.9); border-radius: 10px 10px 0 0; opacity: 0.9; }
        .t-title { font-weight: 800; font-size: 14px; color: var(--fuji-teal); margin-bottom: 2px; line-height: 1.2; }
        .t-loc { font-size: 11px; color: #666; }
        .card-edit-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--fuji-teal); cursor: pointer; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .chart-card { padding: 20px; margin: 15px; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius: 24px; border: var(--glass-border); box-shadow: var(--glass-shadow); }
        .exp-block { padding: 16px; margin: 0 15px 15px 15px; display: flex; justify-content: space-between; align-items: center; position: relative; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .exp-cat { font-size: 15px; font-weight: 800; color: var(--fuji-teal); }
        .exp-item { font-size: 12px; color: #666; font-weight: 500; }
        .exp-pay { font-size: 10px; color: var(--fuji-red); background:#fff0f0; padding:2px 6px; border-radius:4px; margin-left:5px; }
        .exp-amt { font-size: 16px; font-weight: 800; color: #111; letter-spacing: -0.5px; }
        .exp-avg { font-size: 11px; color: #666; margin-top: 2px; }
        .settle-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .settle-table th { text-align: left; color: #666; padding-bottom: 8px; font-weight: normal; }
        .settle-table td { padding: 6px 0; border-top: 1px dashed rgba(0,0,0,0.1); font-weight: bold; }
        .money-pos { color: var(--fuji-red); } .money-neg { color: var(--fuji-teal); }

        .pack-item { padding: 15px; margin: 10px 15px; background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: var(--glass-shadow); }
        .check-box.checked { background: var(--fuji-teal); color: white; border-color: var(--fuji-teal); }

        .nav-container { position: fixed; bottom: 25px; left: 20px; right: 20px; height: 75px; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; display: flex; justify-content: space-around; align-items: center; z-index: 2000; box-shadow: var(--glass-shadow); padding: 0 10px; border: 1px solid rgba(255,255,255,0.5); }
        .nav-btn { text-align: center; color: #999; font-size: 10px; font-weight: 700; flex: 1; transition: 0.2s; }
        .nav-btn.active { color: var(--fuji-teal); transform: translateY(-3px); }
        .nav-icon { font-size: 26px; display: block; margin-bottom: 2px; }
        .fab { position: fixed; bottom: 120px; left: 25px; width: 60px; height: 60px; background: var(--fuji-red); color: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: var(--glass-shadow); z-index: 2100; cursor: pointer; transition: opacity 0.3s; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal.open { display: flex; }
        .modal-card { background: #fff; width: 85%; max-width: 400px; padding: 25px; border-radius: 24px; box-shadow: var(--shadow-float); animation: popUp 0.3s; max-height: 80vh; overflow-y: auto; }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        input, select { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; margin-bottom: 15px; background: #fff; font-family: inherit; color: var(--fuji-teal); font-weight: bold; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 14px; font-size: 15px; font-weight: 800; cursor: pointer; }
        .btn-primary { background: var(--fuji-teal); color: white; }
        .btn-sec { background: #f0f0f0; color: #555; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>
    <div class="app-header"><div class="app-title">2026„ÅÆÂåóÊµ∑ÈÅìÈ£üË∂≥‰∏âÈ§ê‰πãÊóÖüß£</div></div>

    <div id="pg-plan" class="page active">
        <div class="plan-sticky-header">
            <div class="dashboard-container" id="dashboard">
                <div class="close-map" onclick="closeMap()">Close Map ‚úï</div>
                <div class="dash-overlay" id="dashInfo">
                    <div class="dash-content">
                        <div class="dash-loc" id="dashLoc">Sapporo</div>
                        <div class="dash-sub" id="dashWeather">‚ùÑÔ∏è -6¬∞C</div>
                    </div>
                    <div><div class="dash-rate">$100 JPY = $5.3 HKD</div></div>
                </div>
                <iframe class="dash-map" id="dashMapFrame" src=""></iframe>
            </div>
            <div class="date-strip" id="dateStrip"></div>
            <div class="hotel-bar" id="hotelBar">üè® Loading...</div>
        </div>
        <div class="timeline-block"><div class="time-axis" id="timeAxis"></div><div class="events-area" id="eventsArea"></div></div>
    </div>

    <div id="pg-spend" class="page">
        <div class="chart-card">
            <div style="text-align:center; font-size:12px; font-weight:800; color:#666; letter-spacing:1px; margin-bottom:5px;">POOL SPENDING</div>
            <div style="text-align:center; font-size:36px; font-weight:800; color:var(--text-dark);">$<span id="totalSpend">0</span></div>
            <div style="width:140px; height:140px; border-radius:50%; background:rgba(255,255,255,0.5); margin:15px auto; position:relative;" id="poolPie"></div>
        </div>
        <div class="chart-card">
            <div style="text-align:center; font-size:14px; font-weight:800; color:var(--fuji-teal); margin-bottom:15px;">SETTLEMENT (Who owes who)</div>
            <div id="settlementTable"></div>
            <div style="text-align:center; font-size:10px; color:#666; margin-top:10px;">*Only counts 'Group' expenses</div>
        </div>
        <div style="margin: 0 15px 15px 15px; font-size:16px; font-weight:800; color:var(--fuji-teal); letter-spacing:1px;">TRANSACTIONS</div>
        <div id="expenseList"></div>
    </div>

    <div id="pg-pack" class="page">
        <div style="margin:20px 15px 15px 15px; font-size:20px; font-weight:8
