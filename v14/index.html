<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <title>Hokkaido V17</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --fuji-teal: #2A4B55; --fuji-red: #B54B4B; --fuji-gold: #D4AF37; --text-dark: #1a1a1a;
            --glass-bg: rgba(255, 255, 255, 0.85); /* Slightly more opaque for readability */
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --glass-blur: blur(20px);
            --slot-height: 70px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'M PLUS Rounded 1c', sans-serif !important; }
        body { margin: 0; padding: 0; color: var(--text-dark); padding-bottom: 140px; background: url('mailbox.png') no-repeat center center fixed; background-size: cover; min-height: 100vh; }
        
        /* GLASS UI CLASSES */
        .glass-panel { background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border: var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 24px; }
        
        .app-header { position: sticky; top: 10px; z-index: 1000; margin: 0 15px 15px 15px; padding: 12px; text-align: center; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius: 16px; box-shadow: var(--glass-shadow); }
        .app-title { font-size: 17px; font-weight: 800; color: var(--fuji-teal); letter-spacing: 0.5px; }
        
        .plan-sticky-header { position: sticky; top: 75px; z-index: 900; margin: 0 -10px; padding: 0 10px 5px 10px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        
        .dashboard-container { margin: 15px 15px; height: auto; min-height: 200px; border-radius: 24px; overflow: hidden; position: relative; background: url('tree.png') no-repeat center right; background-size: cover; color: var(--text-dark); border: 2px solid rgba(255,255,255,0.5); box-shadow: var(--glass-shadow); transition: 0.3s; }
        .dash-overlay { padding: 25px; display: flex; flex-direction: column; justify-content: space-between; min-height: 200px; gap: 10px; }
        .dash-content { display: flex; flex-direction: column; align-items: flex-start; max-width: 65%; }
        
        /* UPDATED DASHBOARD TEXT STYLES */
        .dash-loc { font-size: 24px; font-weight: 800; color: #111; line-height: 1.1; margin-bottom: 5px; text-shadow: 0 2px 10px rgba(255,255,255,0.8); }
        .dash-sub { font-size: 32px; font-weight: 800; color: var(--fuji-teal); line-height: 1; text-shadow: 0 2px 10px rgba(255,255,255,0.8); display: flex; align-items: center; gap: 8px; }
        .dash-attraction { font-size: 16px; font-weight: 700; color: #444; margin-top: 5px; background: rgba(255,255,255,0.6); padding: 4px 10px; border-radius: 10px; backdrop-filter: blur(5px); }

        .dash-rate { background: rgba(255,255,255,0.9); padding: 8px 12px; border-radius: 12px; font-size: 13px; font-weight: 800; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: var(--fuji-teal); backdrop-filter: blur(10px); }
        .dash-map { display: none; width: 100%; height: 100%; border: none; min-height: 200px; }
        .close-map { position: absolute; top: 15px; right: 15px; background: var(--fuji-red); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight:bold; cursor: pointer; display: none; z-index: 50; }

        .date-strip { overflow-x: auto; white-space: nowrap; padding: 0 15px; margin-bottom: 10px; scrollbar-width: none; }
        .date-pill { display: inline-block; padding: 15px 20px; margin-right: 10px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 18px; color: #666; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; min-width: 110px; border: 1px solid rgba(255,255,255,0.3); }
        .date-pill.active { background: var(--fuji-teal); color: #fff; transform: scale(1.05); box-shadow: 0 8px 20px rgba(42, 75, 85, 0.3); }
        .d-wk { font-size: 14px; font-weight: 800; margin-bottom: 2px; }

        /* HOTEL BAR UPDATED */
        .hotel-bar { margin: 15px; padding: 15px; text-align: center; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 20px; border: var(--glass-border); box-shadow: var(--glass-shadow); display: flex; flex-direction: column; gap: 5px; align-items: center; justify-content: center; }
        .hotel-name { font-weight: 800; font-size: 15px; color: var(--fuji-teal); }
        .hotel-map-link { font-size: 12px; color: var(--fuji-red); text-decoration: none; font-weight: 700; background: rgba(255,255,255,0.5); padding: 4px 10px; border-radius: 8px; }

        .timeline-block { margin: 15px; padding: 20px 0; min-height: 500px; overflow: hidden; position: relative; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius: 24px; border: var(--glass-border); box-shadow: var(--glass-shadow); }
        .time-axis { position: absolute; left: 0; top: 20px; bottom: 20px; width: 80px; border-right: 2px dashed rgba(0,0,0,0.1); }
        .events-area { margin-left: 80px; position: relative; min-height: 100%; }
        .time-slot { height: var(--slot-height); position: relative; }
        .ts-label { position: absolute; right: 12px; top: -10px; font-size: 12px; font-weight:800; color: #888; background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 6px; }
        
        .sun-marker-axis { position: absolute; left: 5px; right: 5px; height: 1px; border-top: 2px dotted var(--fuji-gold); z-index: 5; pointer-events: none; }
        .sun-text-axis { position: absolute; left: 0; top: -18px; width: 100%; text-align: center; font-size: 9px; background: #fff; border-radius: 4px; color: var(--fuji-gold); font-weight: bold; padding: 1px; border: 1px solid var(--fuji-gold); }

        .t-event { position: absolute; left: 10px; right: 15px; background: rgba(244, 242, 233, 0.95); border-radius: 12px; padding: 8px 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); z-index: 10; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); }
        .t-event::before { content: ''; position: absolute; top: -5px; left: 8px; right: 8px; height: 8px; background: rgba(255,255,255,0.9); border-radius: 10px 10px 0 0; opacity: 0.9; }
        .t-title { font-weight: 800; font-size: 14px; color: var(--fuji-teal); margin-bottom: 2px; line-height: 1.2; }
        .t-loc { font-size: 11px; color: #666; }
        .card-edit-btn { position: absolute; top: 8px; right: 8px; width: 28px; height: 28px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--fuji-teal); cursor: pointer; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .chart-card { padding: 20px; margin: 15px; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius: 24px; border: var(--glass-border); box-shadow: var(--glass-shadow); }
        
        /* EXPENSE GROUPING */
        .exp-group-title { margin: 20px 15px 10px 15px; font-size: 14px; font-weight: 800; color: var(--fuji-teal); opacity: 0.8; letter-spacing: 0.5px; border-bottom: 2px solid rgba(42, 75, 85, 0.1); padding-bottom: 5px; }
        .exp-block { padding: 16px; margin: 0 15px 10px 15px; display: flex; justify-content: space-between; align-items: center; position: relative; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .exp-cat { font-size: 15px; font-weight: 800; color: var(--fuji-teal); }
        .exp-item { font-size: 13px; color: #444; font-weight: 600; }
        .exp-pay { font-size: 10px; color: var(--fuji-red); background:#fff0f0; padding:2px 6px; border-radius:4px; margin-left:5px; }
        .exp-amt { font-size: 16px; font-weight: 800; color: #111; letter-spacing: -0.5px; }
        .exp-avg { font-size: 11px; color: #666; margin-top: 2px; }

        /* PIE LEGEND */
        .pie-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .legend-item { font-size: 11px; display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        .settle-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .settle-table th { text-align: left; color: #666; padding-bottom: 8px; font-weight: normal; }
        .settle-table td { padding: 6px 0; border-top: 1px dashed rgba(0,0,0,0.1); font-weight: bold; }
        .money-pos { color: var(--fuji-red); } .money-neg { color: var(--fuji-teal); }

        .pack-item { padding: 15px; margin: 10px 15px; background: rgba(255,255,255,0.85); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: var(--glass-shadow); }
        .check-box.checked { background: var(--fuji-teal); color: white; border-color: var(--fuji-teal); }

        /* NAV & FAB UPDATED */
        .nav-container { position: fixed; bottom: 25px; left: 20px; right: 20px; height: 75px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; display: flex; justify-content: space-around; align-items: center; z-index: 2000; box-shadow: var(--glass-shadow); padding: 0 10px; border: 1px solid rgba(255,255,255,0.5); }
        .nav-btn { text-align: center; color: #999; font-size: 10px; font-weight: 700; flex: 1; transition: 0.3s; padding: 10px; border-radius: 16px; }
        /* Active Tab with Shadow & Highlight */
        .nav-btn.active { color: var(--fuji-teal); background: rgba(42, 75, 85, 0.1); box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); transform: translateY(-2px); }
        .nav-icon { font-size: 24px; display: block; margin-bottom: 2px; }
        .fab { position: fixed; bottom: 120px; left: 25px; width: 60px; height: 60px; background: var(--fuji-red); color: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: var(--glass-shadow); z-index: 2100; cursor: pointer; transition: opacity 0.3s; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal.open { display: flex; }
        .modal-card { background: #fff; width: 85%; max-width: 400px; padding: 25px; border-radius: 24px; box-shadow: var(--shadow-float); animation: popUp 0.3s; max-height: 80vh; overflow-y: auto; }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        input, select { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; margin-bottom: 15px; background: #fff; font-family: inherit; color: var(--fuji-teal); font-weight: bold; }
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 14px; font-size: 15px; font-weight: 800; cursor: pointer; }
        .btn-primary { background: var(--fuji-teal); color: white; }
        .btn-sec { background: #f0f0f0; color: #555; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>
    <div class="app-header"><div class="app-title">2026„ÅÆÂåóÊµ∑ÈÅìÈ£üË∂≥‰∏âÈ§ê‰πãÊóÖüß£</div></div>

    <div id="pg-plan" class="page active">
        <div class="plan-sticky-header">
            <div class="dashboard-container" id="dashboard">
                <div class="close-map" onclick="closeMap()">Close Map ‚úï</div>
                <div class="dash-overlay" id="dashInfo">
                    <div class="dash-content">
                        <div class="dash-loc" id="dashLoc">Sapporo</div>
                        <div class="dash-sub" id="dashWeather">‚ùÑÔ∏è -6¬∞C</div>
                        <div class="dash-attraction" id="dashHighlight">üìç Main Attraction: Loading...</div>
                    </div>
                    <div><div class="dash-rate">$100 JPY = $5.3 HKD</div></div>
                </div>
                <iframe class="dash-map" id="dashMapFrame" src=""></iframe>
            </div>
            <div class="date-strip" id="dateStrip"></div>
            <div class="hotel-bar" id="hotelBar">
                <div class="hotel-name">üè® Loading Hotel...</div>
            </div>
        </div>
        <div class="timeline-block"><div class="time-axis" id="timeAxis"></div><div class="events-area" id="eventsArea"></div></div>
    </div>

    <div id="pg-spend" class="page">
        <div class="chart-card">
            <div style="text-align:center; font-size:12px; font-weight:800; color:#666; letter-spacing:1px; margin-bottom:5px;">POOL SPENDING</div>
            <div style="text-align:center; font-size:36px; font-weight:800; color:var(--text-dark);">$<span id="totalSpend">0</span></div>
            <div style="width:140px; height:140px; border-radius:50%; background:rgba(255,255,255,0.5); margin:15px auto; position:relative;" id="poolPie"></div>
            <div class="pie-legend" id="pieLegend"></div>
        </div>
        <div class="chart-card">
            <div style="text-align:center; font-size:14px; font-weight:800; color:var(--fuji-teal); margin-bottom:15px;">SETTLEMENT (Who owes who)</div>
            <div id="settlementTable"></div>
            <div style="text-align:center; font-size:10px; color:#666; margin-top:10px;">*Only counts 'Group' expenses</div>
        </div>
        <div style="margin: 0 15px 15px 15px; font-size:16px; font-weight:800; color:var(--fuji-teal); letter-spacing:1px;">TRANSACTIONS</div>
        <div id="expenseList"></div>
    </div>

    <div id="pg-pack" class="page">
        <div style="margin:20px 15px 15px 15px; font-size:20px; font-weight:800; color:var(--fuji-teal);">üéí To Pack List</div>
        <div style="margin:0 15px 15px 15px; display:flex; gap:10px;">
            <input type="text" id="newPackItem" placeholder="Add item..." style="margin:0;">
            <button class="btn-primary" style="flex:0 0 70px;" onclick="addPackItem()">Add</button>
        </div>
        <div id="packListContainer"></div>
    </div>

    <div class="nav-container">
        <div class="nav-btn active" onclick="nav('plan')"><span class="nav-icon">üóì</span>Plan</div>
        <div class="nav-btn" onclick="nav('spend')"><span class="nav-icon">üí¥</span>Spend</div>
        <div class="nav-btn" onclick="nav('pack')"><span class="nav-icon">üéí</span>Pack</div>
    </div>
    <div class="fab" id="mainFab" onclick="clickAdd()">+</div>

    <div class="modal" id="modal">
        <div class="modal-card">
            <h3 id="mTitle" style="margin-top:0; color:var(--fuji-teal);">Edit</h3>
            <input type="hidden" id="mId"><input type="hidden" id="mMode">
            <div id="fPlan" style="display:none;">
                <label style="font-size:12px; font-weight:bold; color:#666;">Time</label>
                <div style="display:flex; gap:10px;"><input type="time" id="inpStart"><input type="time" id="inpEnd"></div>
                <input type="text" id="inpTitle" placeholder="Activity"><input type="text" id="inpLoc" placeholder="Location">
            </div>
            <div id="fSpend" style="display:none;">
                <input type="text" id="spItem" placeholder="Item Name">
                <div style="display:flex; gap:10px;"><input type="number" id="spAmt" placeholder="Amount"><select id="spCurr"><option value="HKD">HKD</option><option value="JPY">JPY</option></select></div>
                <select id="spMethod"><option value="Credit Card">Credit Card üí≥</option><option value="Cash">Cash üí¥</option><option value="Suica/IC">Suica/IC üêß</option><option value="Alipay">Alipay</option></select>
                <select id="spPayer"><option value="Pool">Pool</option><option value="Rachel">Rachel</option><option value="Daniel">Daniel</option><option value="Diaz">Diaz</option><option value="Skye">Skye</option></select>
                <select id="spCat"><option value="Food">Food üçî</option><option value="Transport">Transport üöÜ</option><option value="Hotel">Hotel üè®</option><option value="Attractions">Attractions üé°</option><option value="Shopping">Shopping üõç</option><option value="Other">Other üì¶</option></select>
                <select id="spType"><option value="Group">Group</option><option value="Personal">Personal</option></select>
            </div>
            <div class="btn-row"><button class="btn-sec" onclick="closeModal()">Cancel</button><button class="btn-primary" style="background:var(--fuji-red)" onclick="doDelete()">Delete</button><button class="btn-primary" onclick="doSave()">Save</button></div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION (V17 - Final) ---
        const firebaseConfig = {
          apiKey: "AIzaSyCywE_gs1H7-lw21_52hFwpT8mPjLS_8i8",
          authDomain: "hokkaido2026-5ad8b.firebaseapp.com",
          databaseURL: "https://hokkaido2026-5ad8b-default-rtdb.firebaseio.com/",
          projectId: "hokkaido2026-5ad8b",
          storageBucket: "hokkaido2026-5ad8b.firebasestorage.app",
          messagingSenderId: "542618426908",
          appId: "1:542618426908:web:b1d41b39375f788576c9d9"
        };
        // ------------------------------------------

        const RATE=0.053; 
        // 1. HOTEL DATA WITH MAP CODES
        const HOTEL_INFO = {
            "2026-01-08": { name: "Â§öÁ±≥PREMIUMÈÖíÂ∫ó (Otaru)", code: "493 690 505" },
            "2026-01-09": { name: "Êú≠ÂπåÂ§ßÈÄöÂÖ¨ÂúíÊôØËßÄÈÖíÂ∫ó", code: "9 492 406" },
            "2026-01-10": { name: "Êú≠ÂπåÂ§ßÈÄöÂÖ¨ÂúíÊôØËßÄÈÖíÂ∫ó", code: "9 492 406" },
            "2026-01-11": { name: "ÂØåËâØÈáéÊãâÁ∂≠ÊñØÂ°îÊ∏©Ê≥âÈÖíÂ∫ó", code: "450 028 223" },
            "2026-01-12": { name: "ÂØåËâØÈáéÊãâÁ∂≠ÊñØÂ°îÊ∏©Ê≥âÈÖíÂ∫ó", code: "450 028 223" },
            "2026-01-13": { name: "Êó≠Â∑ùÁ´ôÂâçÊ∞∏ÂÆâÂúãÈöõÈÖíÂ∫ó", code: "79 342 546" },
            "2026-01-14": { name: "Kamui‰πãÊπØLa VistaÈòøÂØíÂ∑ù", code: "739 342 604" },
            "2026-01-15": { name: "Kamui‰πãÊπØLa VistaÈòøÂØíÂ∑ù", code: "739 342 604" },
            "2026-01-16": { name: "Áí∞ÁêÉÊôØËßÄÈÖíÂ∫óÈáßË∑Ø", code: "149 256 525" },
            "2026-01-17": { name: "Êú≠ÂπåÁéãÂ≠êÈÖíÂ∫ó", code: "9 491 578" },
            "2026-01-18": { name: "Home Sweet Home", code: "N/A" }
        };

        // 2. DAILY HIGHLIGHTS
        const DAILY_HIGHLIGHTS = {
            "2026-01-08": "Otaru Arrival üç£",
            "2026-01-09": "Otaru Canal üì∑",
            "2026-01-10": "Shiroi Koibito üç™",
            "2026-01-11": "Ningle Terrace üßö‚Äç‚ôÄÔ∏è",
            "2026-01-12": "Skiing Day ‚õ∑Ô∏è",
            "2026-01-13": "Biei Trees üå≤",
            "2026-01-14": "Asahiyama Zoo üêß",
            "2026-01-15": "Lake Akan Activity ‚ùÑÔ∏è",
            "2026-01-16": "Kushiro Sunset üåÖ",
            "2026-01-17": "Shopping Day üõçÔ∏è",
            "2026-01-18": "Flight Home ‚úàÔ∏è"
        };

        const WEATHER_DATA = {"2026-01-08": "‚ùÑÔ∏è -6¬∞C Snow", "2026-01-09": "üå•Ô∏è -4¬∞C Cloudy", "2026-01-10": "‚ùÑÔ∏è -7¬∞C Heavy Snow", "2026-01-11": "ü•∂ -12¬∞C Freezing", "2026-01-12": "‚õ∑Ô∏è -10¬∞C Powder", "2026-01-13": "üå•Ô∏è -8¬∞C Biei Cloudy", "2026-01-14": "üêß -9¬∞C Zoo Day", "2026-01-15": "‚ô®Ô∏è -15¬∞C Akan Cold", "2026-01-16": "üåÖ -10¬∞C Sunrise", "2026-01-17": "üõçÔ∏è -5¬∞C Sapporo", "2026-01-18": "‚úàÔ∏è -4¬∞C Home"};
        const PEOPLE=['Rachel','Daniel','Diaz','Skye'];
        const CATEGORIES = ["Food", "Transport", "Hotel", "Attractions", "Shopping", "Other"];
        const CAT_COLORS = {'Food':'#FF9500', 'Transport':'#5856D6', 'Hotel':'#FF2D55', 'Attractions':'#AF52DE', 'Shopping':'#30B0C7', 'Other':'#888'};

        // DATA RESTORED
        const rawSch=[
            ["2026-01-08","05:30","06:30","Âá∫ÁôºÊ©üÂ†¥ üõ´","HKG"], ["2026-01-08","06:30","09:00","Ê©üÂ†¥ / Êó©È§ê ü•£","HKG Airport"], ["2026-01-08","09:00","15:30","HB008 HKG - CTS ‚úàÔ∏è","Flight"], ["2026-01-08","15:30","16:30","ÊîûË°åÊùé üß≥","CTS"], ["2026-01-08","16:30","17:30","ÊîûËªä üöó","CTS Rental"], ["2026-01-08","17:30","19:00","ÈñãËªäÂà∞Â∞èÊ®Ω ü´ô","Drive"], ["2026-01-08","19:00","20:00","ÊôöÈ§ê (ÊîøÂ£ΩÂè∏ üç£)","Otaru"], ["2026-01-08","20:00","21:00","Check in ÈÖíÂ∫ó üè®","Dormy Inn"], ["2026-01-08","21:00","22:00","Â§©ÁãóÂ±±Â§úÊôØ üåõ","Tenguyama"], ["2026-01-08","23:00","23:59","Ë¶ÅË®ìË¶∫Âïä üò¥","Otaru"],
            ["2026-01-09","07:00","08:00","Ëµ∑Ë∫´ üåû","Otaru"], ["2026-01-09","08:00","12:30","ÊãçÁÖß üì∑","Otaru Canal"], ["2026-01-09","12:30","14:00","ÂçàÈ§ê üç±","Otaru"], ["2026-01-09","14:00","18:00","Â∞èÊ®Ω9ÈÄõ üõçÔ∏è","Sakaimachi"], ["2026-01-09","18:00","19:30","ÈñãËªäÂà∞Êú≠Âπå üöó","Drive"], ["2026-01-09","19:30","21:00","ÊôöÈ§ê (Áâõ‰πÉÂÆ∂ üçú)","Sapporo"], ["2026-01-09","21:00","22:00","Check in & ‰ºëÊÅØ","Sapporo Hotel"], ["2026-01-09","23:00","23:59","Ë¶ÅË®ìË¶∫Âïä üí§","Sapporo"],
            ["2026-01-10","07:00","08:00","Ëµ∑Ë∫´ üåû","Sapporo"], ["2026-01-10","08:00","09:30","Âá∫ÈñÄ / Êó©È§ê ü•£","Sapporo"], ["2026-01-10","09:30","12:30","ÁôΩ‰πãÊàÄ‰∫∫ÂçöÁâ©È§® üç™","Shiroi Koibito"], ["2026-01-10","12:30","14:30","ÂçàÈ§ê (ËüπÈÅä‰∫≠ ü¶Ä)","Sapporo"], ["2026-01-10","15:00","17:30","Êú≠ÂπåÂï§ÈÖíÂçöÁâ©È§® üç∫","Sapporo Beer"], ["2026-01-10","19:00","21:00","ÊôöÈ§ê (ÂÜ∞Èõ™‰πãÈñÄ ü¶Ä)","Sapporo"], ["2026-01-10","21:00","23:00","‰ºëÊÅØ üõå","Hotel"],
            ["2026-01-11","07:00","08:30","Ëµ∑Ë∫´ / Êó©È§ê ü•£","Sapporo"], ["2026-01-11","09:00","11:30","ÈñãËªäÂà∞ÂØåËâØÈáé üöó","Drive"], ["2026-01-11","12:30","14:00","ÂçàÈ§ê üç±","Furano"], ["2026-01-11","14:30","17:30","Â≠∏ÊªëÈõ™ & ÈÅ©ÊáâÈõ™Â†¥ ‚õ∑Ô∏è","Furano Ski"], ["2026-01-11","18:00","19:30","Á≤æÈùàÈú≤Âè∞ üßö‚Äç‚ôÄÔ∏è","Ningle Terrace"], ["2026-01-11","19:30","21:00","ÊôöÈ§ê ü•ò","Furano"],
            ["2026-01-12","08:00","09:00","Ëµ∑Ë∫´ / Êó©È§ê ü•£","Furano"], ["2026-01-12","09:00","12:30","ÊªëÈõ™ ‚õ∑Ô∏è","Furano Ski"], ["2026-01-12","12:30","14:00","ÂçàÈ§ê üç±","Ski Resort"], ["2026-01-12","14:00","17:00","ÊªëÈõ™ ‚õ∑Ô∏è","Furano Ski"], ["2026-01-12","18:00","19:00","ÊôöÈ§ê ü•ò","Furano"], ["2026-01-12","19:00","20:30","‰ºëÊÅØ ‚ô®Ô∏è","Hotel"],
            ["2026-01-13","07:00","08:30","Ëµ∑Ë∫´ / Êó©È§ê ü•£","Furano"], ["2026-01-13","08:30","09:30","ÈñãËªäÂà∞ÁæéÁëõ üöó","Drive"], ["2026-01-13","09:30","10:30","ËÅñË™ïÊ®π üéÑ","Biei"], ["2026-01-13","10:30","11:30","Mild Seven Hills üå≤","Biei"], ["2026-01-13","11:30","13:30","ÁæéÁëõ„ÅÆÊ£Æ KONON ‚òï","Cafe"], ["2026-01-13","13:30","14:30","ÂõõÂ≠£ÂΩ©‰πã‰∏ò üå∏","Biei"], ["2026-01-13","14:30","15:30","Ê∏ÖÊ±† / ÁÄëÂ∏É üíß","Blue Pond"], ["2026-01-13","16:30","17:30","Êó≠Â∑ù (Check in)","Asahikawa"], ["2026-01-13","18:00","20:00","ÊôöÈ§ê (ÊàêÂêâÊÄùÊ±óÂ§ßÈªëÂ±ã) ü•©","Asahikawa"],
            ["2026-01-14","07:00","09:00","Ëµ∑Ë∫´ / Êó©È§ê ü•£","Asahikawa"], ["2026-01-14","09:30","12:00","Êó≠Â∑ùÂãïÁâ©Âúí üêß","Asahiyama Zoo"], ["2026-01-14","12:00","16:00","ÂéªÈòøÂØíÊπñ (Drive) üöó","Drive"], ["2026-01-14","16:30","23:00","Ê∫´Ê≥âÊóÖÈ§®‰ºëÊÅØ & ÂòÜ ‚ô®Ô∏è","La Vista Akan"],
            ["2026-01-15","07:00","09:00","Ëµ∑Ë∫´ / Êó©È§ê ü•£","Akan"], ["2026-01-15","09:30","16:00","ÈòøÂØíÊπñ (Activity) ‚ùÑÔ∏è","Lake Akan"], ["2026-01-15","16:30","23:00","Ê∫´Ê≥âÊóÖÈ§®‰ºëÊÅØ & ÂòÜ ‚ô®Ô∏è","La Vista"],
            ["2026-01-16","07:00","09:00","Ëµ∑Ë∫´ / Êó©È§ê ü•£","Akan"], ["2026-01-16","10:00","10:30","Check out üè®","Akan"], ["2026-01-16","10:30","13:00","Âá∫ÁôºÂéªÂéöÂ≤∏ üöó","Drive"], ["2026-01-16","13:00","14:30","ü¶™Ë†î (ÂéöÂ≤∏Ë†î)","Akkeshi"], ["2026-01-16","14:30","16:00","ÂΩ±Êó•ËêΩ üåÖ","Kushiro"], ["2026-01-16","16:00","17:30","Âá∫ÁôºÂ∑ùË∑Ø / Check in","Kushiro"], ["2026-01-16","17:30","19:00","ÊôöÈ§ê ü•ò","Kushiro"],
            ["2026-01-17","07:00","09:00","Ëµ∑Ë∫´ / Êó©È§ê ü•£","Kushiro"], ["2026-01-17","09:00","13:00","ÈñãÂéªÊú≠Âπå üöó","Drive"], ["2026-01-17","13:00","14:30","ÂçàÈ§ê üç±","Sapporo"], ["2026-01-17","16:00","20:00","Êú≠Âπå City / Shopping üõçÔ∏è","Sapporo"], ["2026-01-17","20:00","21:30","ÊôöÈ§ê ü•ò","Sapporo"],
            ["2026-01-18","08:00","09:00","Êó©È§ê ü•£","Sapporo"], ["2026-01-18","09:00","13:00","ÈñãÂéªÊ©üÂ†¥ üöó","Drive"], ["2026-01-18","13:00","14:00","ÈÇÑËªäüöóÔºàÊàêÁî∞Ê©üÂ†¥? CTS)","CTS Rental"], ["2026-01-18","14:00","16:00","Ê©üÂ†¥ Checkin","CTS"], ["2026-01-18","16:00","21:00","HB008 HKG - CTS ‚úàÔ∏è","Flight"], ["2026-01-18","21:30","22:30","ËøîÂ±ã‰ºÅ üè†","HK"]
        ];
        const rawExp=[
            { id:1, item:"Hotel: Otaru", amount:1327, curr:"HKD", payer:"Rachel", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:2, item:"Hotel: Sapporo", amount:2449, curr:"HKD", payer:"Rachel", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:3, item:"Hotel: Furano", amount:6551, curr:"HKD", payer:"Rachel", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:4, item:"Hotel: Asahikawa", amount:918, curr:"HKD", payer:"Rachel", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:5, item:"Hotel: Akan", amount:867, curr:"HKD", payer:"Rachel", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:6, item:"Hotel: Kushiro", amount:867, curr:"HKD", payer:"Rachel", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:7, item:"Hotel: Sapporo", amount:2235, curr:"HKD", payer:"Rachel", cat:"Hotel", type:"Group", method:"Credit Card" }
        ];
        
        let appData = { currDate:"2026-01-08", schedule:rawSch.map((s,i)=>({id:i,date:s[0],start:s[1],end:s[2],title:s[3],loc:s[4]})), expenses:rawExp, packList:[{id:1,text:"Passport",checks:{'Diaz':false,'Rachel':false,'Skye':false,'Daniel':false}}] };
        let dbRef = null;

        // --- INIT SYNC ---
        function initApp() {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            // USING FULL DATASET V17
            dbRef = db.ref('hokkaido_v17_full');
            
            dbRef.on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    appData = val; 
                    refresh();
                } else {
                    save();
                }
            });
        }

        function save() {
            if (dbRef) dbRef.set(appData);
        }

        const fmtMoney=(n)=>n.toLocaleString('en-US',{minimumFractionDigits:1,maximumFractionDigits:1});
        const SLOT_HEIGHT=70;

        function refresh(){
            renderDates();
            renderTimeline();
            renderExpenses(); // Now grouped!
            renderPackList();
            
            // HOTEL BAR FIX (Map Link)
            const h = HOTEL_INFO[appData.currDate];
            if (h) {
                const mapLink = h.code !== 'N/A' ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name)}` : '#';
                document.getElementById('hotelBar').innerHTML = `
                    <div class="hotel-name">üè® ${h.name}</div>
                    <a href="${mapLink}" target="_blank" class="hotel-map-link">Map Code: ${h.code} ‚Üó</a>
                `;
            } else {
                document.getElementById('hotelBar').innerHTML = '<div>üè® No Hotel</div>';
            }
            
            // DASHBOARD FIX (Highlight)
            document.getElementById('dashHighlight').innerText = "üìç " + (DAILY_HIGHLIGHTS[appData.currDate] || "Free Day");
        }

        function renderTimeline(){
            const ax=document.getElementById('timeAxis'), ar=document.getElementById('eventsArea');
            ax.innerHTML='';ar.innerHTML='';
            for(let i=5;i<=24;i++){
                const d=document.createElement('div');d.className='time-slot';
                // 3. 24H TIME FIX
                const label = `${i.toString().padStart(2, '0')}:00`;
                d.innerHTML=`<div class="ts-label">${label}</div>`;ax.appendChild(d);
                const li=document.createElement('div');li.className='time-slot';li.style.borderBottom='1px dashed rgba(0,0,0,0.1)';ar.appendChild(li);
            }
            if(appData.schedule) {
                appData.schedule.filter(e=>e.date===appData.currDate).forEach(e=>{
                    const sH=parseInt(e.start.split(':')[0]), sM=parseInt(e.start.split(':')[1]);
                    const eH=parseInt(e.end.split(':')[0]), eM=parseInt(e.end.split(':')[1]);
                    const st=(sH-5)*60+sM; const du=((eH-5)*60+eM)-st;
                    const top=(st/60)*SLOT_HEIGHT; const h=(du/60)*SLOT_HEIGHT;
                    if(top>=0){
                        const el=document.createElement('div');el.className='t-event';el.style.top=(top+10)+'px';el.style.height=(h>30?h-5:35)+'px';
                        el.innerHTML=`<div class="t-title">${e.title}</div><div class="t-loc">üìç ${e.loc}</div><div class="card-edit-btn" onclick="editEvent(event,${e.id})">‚úé</div>`;
                        el.onclick=()=>showMap(e.loc);ar.appendChild(el);
                    }
                });
            }
            addSun(ax,"07:06","üåÖ Sunrise");addSun(ax,"16:20","üåá Sunset");
        }
        function addSun(c,t,i){const h=parseInt(t.split(':')[0]),m=parseInt(t.split(':')[1]);const mn=(h-5)*60+m;const tp=(mn/60)*SLOT_HEIGHT;if(tp>0){const d=document.createElement('div');d.className='sun-marker-axis';d.style.top=tp+'px';d.innerHTML=`<div class="sun-text-axis">${i} ${t}</div>`;c.appendChild(d);}}

        // 7. GROUPED TRANSACTIONS FIX
        function renderExpenses(){
            const l=document.getElementById('expenseList');l.innerHTML='';
            let tg=0; let pb={'Rachel':0,'Daniel':0,'Diaz':0,'Skye':0}; let catTotals={};
            
            // Initial calculation for totals
            if(appData.expenses) {
                appData.expenses.forEach(e=>{
                    let v=e.curr==='JPY'?e.amount*RATE:e.amount;
                    if(e.type==='Group'){ tg+=v; if(e.cat)catTotals[e.cat]=(catTotals[e.cat]||0)+v; if(pb[e.payer]!==undefined)pb[e.payer]+=v; }
                });
            }

            // Render by Category
            CATEGORIES.forEach(cat => {
                const items = appData.expenses ? appData.expenses.filter(e => e.cat === cat) : [];
                if (items.length > 0) {
                    const groupTitle = document.createElement('div');
                    groupTitle.className = 'exp-group-title';
                    const icon = cat==='Food'?'üçî':cat==='Transport'?'üöÜ':cat==='Hotel'?'üè®':cat==='Attractions'?'üé°':cat==='Shopping'?'üõçÔ∏è':'üì¶';
                    groupTitle.innerText = `${icon} ${cat}`;
                    l.appendChild(groupTitle);

                    items.forEach(e => {
                        const d=document.createElement('div');d.className='exp-block';
                        d.innerHTML=`<div class="exp-left"><div class="exp-item">${e.item}<span class="exp-pay">${e.method||'-'}</span></div></div><div class="exp-right"><div class="exp-amt">$${e.curr} ${fmtMoney(e.amount)}</div><div class="exp-avg">${e.payer} Paid</div></div><div class="card-edit-btn" style="position:static;margin-left:10px;width:30px;height:30px;" onclick="editExp(${e.id})">‚úé</div>`;
                        l.appendChild(d);
                    });
                }
            });
            
            document.getElementById('totalSpend').innerText=fmtMoney(tg); 
            renderPie(catTotals,tg); 
            renderSettlement(tg,pb);
        }

        function renderSettlement(t,pb){
            const tb=document.getElementById('settlementTable'); const s=t/4;
            let h=`<table class="settle-table"><thead><tr><th>Person</th><th>Share</th><th>Paid</th><th>Bal (+Owe/-Get)</th></tr></thead><tbody>`;
            PEOPLE.forEach(p=>{
                const pd=pb[p]; const b=s-pd; const cl=b>0?'money-pos':'money-neg';
                const tx=b>0?`HK$${fmtMoney(b)}`:`(HK$${fmtMoney(Math.abs(b))})`;
                h+=`<tr><td>${p}</td><td>$${fmtMoney(s)}</td><td>$${fmtMoney(pd)}</td><td class="${cl}">${tx}</td></tr>`;
            });
            h+=`</tbody></table>`; tb.innerHTML=h;
        }

        // 4. PIE CHART LEGEND FIX
        function renderPie(c,t){
            let d=0,css=[],i=0;
            const legendEl = document.getElementById('pieLegend'); legendEl.innerHTML='';
            
            for(let k in c){
                if(c[k]>0){
                    let p=(c[k]/t)*360;
                    const col = CAT_COLORS[k] || '#999';
                    css.push(`${col} ${d}deg ${d+p}deg`);
                    d+=p;
                    
                    // Add Legend Item
                    legendEl.innerHTML += `<div class="legend-item"><div class="dot" style="background:${col}"></div>${k} (${Math.round((c[k]/t)*100)}%)</div>`;
                }
            }
            if(t>0)document.getElementById('poolPie').style.background=`conic-gradient(${css.join(',')})`;
        }

        function renderPackList(){const c=document.getElementById('packListContainer');c.innerHTML='';if(appData.packList)appData.packList.forEach((i,x)=>{let h='';PEOPLE.forEach(p=>{let k=i.checks[p]?'checked':'';h+=`<div style="flex:1;text-align:center;font-size:10px;color:#888;padding:5px;border:1px solid #eee;border-radius:8px;" class="${k}" onclick="togPack(${x},'${p}')"><div style="width:16px;height:16px;border:1px solid #ccc;border-radius:50%;margin:0 auto 4px;background:white;${k?'background:#fff;border:4px solid var(--fuji-teal);':''}"></div>${p}</div>`;});const d=document.createElement('div');d.className='pack-item';d.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:10px;"><div style="font-weight:800;color:var(--fuji-teal);">${i.text}</div><div style="color:var(--fuji-red);cursor:pointer;" onclick="delPack(${x})">√ó</div></div><div style="display:flex;gap:5px;">${h}</div>`;c.appendChild(d);});}
        
        // 5. PACK ADD FIX
        function addPackItem(){
            const v=document.getElementById('newPackItem').value;
            if(v){
                if(!appData.packList) appData.packList=[];
                appData.packList.push({id:Date.now(),text:v,checks:{}});
                save();
                document.getElementById('newPackItem').value='';
                // Force local refresh immediately for UX
                renderPackList();
            }
        }
        
        function togPack(i,p){appData.packList[i].checks[p]=!appData.packList[i].checks[p];save();}
        function delPack(i){if(confirm('Delete?')){appData.packList.splice(i,1);save();}}
        function showMap(l){document.getElementById('dashInfo').style.display='none';document.getElementById('dashMapFrame').style.display='block';document.querySelector('.close-map').style.display='block';document.getElementById('dashMapFrame').src=`https://maps.google.com/maps?q=${encodeURIComponent(l+' Hokkaido')}&output=embed`;}
        function closeMap(){document.getElementById('dashInfo').style.display='flex';document.getElementById('dashMapFrame').style.display='none';document.querySelector('.close-map').style.display='none';}
        let eId=null;
        function editEvent(e,id){e.stopPropagation();openModal('plan',appData.schedule.find(x=>x.id===id));}
        function editExp(id){openModal('spend',appData.expenses.find(x=>x.id===id));}
        function openModal(m,d){
            document.getElementById('modal').classList.add('open');document.getElementById('mMode').value=m;
            document.getElementById('fPlan').style.display=m==='plan'?'block':'none';document.getElementById('fSpend').style.display=m==='spend'?'block':'none';
            if(d){eId=d.id;document.getElementById('mTitle').innerText='Edit';if(m==='plan'){document.getElementById('inpStart').value=d.start;document.getElementById('inpEnd').value=d.end;document.getElementById('inpTitle').value=d.title;document.getElementById('inpLoc').value=d.loc;}else{document.getElementById('spItem').value=d.item;document.getElementById('spAmt').value=d.amount;document.getElementById('spCurr').value=d.curr;document.getElementById('spCat').value=d.cat;document.getElementById('spPayer').value=d.payer;document.getElementById('spMethod').value=d.method||'Credit Card';document.getElementById('spType').value=d.type||'Group';}}
            else{eId=null;document.getElementById('mTitle').innerText='Add New';}
        }
        function closeModal(){document.getElementById('modal').classList.remove('open');}
        function doSave(){const m=document.getElementById('mMode').value;if(m==='plan'){const s=document.getElementById('inpStart').value,e=document.getElementById('inpEnd').value,t=document.getElementById('inpTitle').value,l=document.getElementById('inpLoc').value;if(eId){const i=appData.schedule.findIndex(x=>x.id===eId);Object.assign(appData.schedule[i],{start:s,end:e,title:t,loc:l});}else {if(!appData.schedule)appData.schedule=[];appData.schedule.push({id:Date.now(),date:appData.currDate,start:s,end:e,title:t,loc:l});}}else{const i=document.getElementById('spItem').value,a=parseFloat(document.getElementById('spAmt').value),c=document.getElementById('spCurr').value,ct=document.getElementById('spCat').value,p=document.getElementById('spPayer').value,mt=document.getElementById('spMethod').value,ty=document.getElementById('spType').value;if(eId){const ix=appData.expenses.findIndex(x=>x.id===eId);Object.assign(appData.expenses[ix],{item:i,amount:a,curr:c,cat:ct,payer:p,method:mt,type:ty});}else {if(!appData.expenses)appData.expenses=[];appData.expenses.push({id:Date.now(),item:i,amount:a,curr:c,cat:ct,payer:p,method:mt,type:ty});}}save();closeModal();}
        function doDelete(){if(eId&&confirm('Delete?')){const m=document.getElementById('mMode').value;if(m==='plan')appData.schedule=appData.schedule.filter(x=>x.id!==eId);else appData.expenses=appData.expenses.filter(x=>x.id!==eId);save();closeModal();}}
        
        function clickAdd(){
            const p=document.querySelector('.page.active').id;
            if(p==='pg-pack') return;
            else openModal(p==='pg-plan'?'plan':'spend',null);
        }
        
        function nav(p){
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.getElementById('pg-'+p).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            event.currentTarget.classList.add('active');
            const fab = document.getElementById('mainFab');
            if(p === 'pack') fab.style.opacity = '0';
            else fab.style.opacity = '1';
        }
        
        function renderDates(){
            const el=document.getElementById('dateStrip');el.innerHTML='';
            const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            for(let i=8;i<=18;i++){
                const d=`2026-01-${i<10?'0'+i:i}`;const dt=new Date(d);const wk=days[dt.getDay()];
                const div=document.createElement('div');div.className=`date-pill ${appData.currDate===d?'active':''}`;
                div.innerHTML=`<div class="d-wk">${wk} ${i} Jan</div>`;
                div.onclick=()=>{
                    appData.currDate=d; closeMap();
                    const w = WEATHER_DATA[d] || "‚ùÑÔ∏è -6¬∞C Snow";
                    document.getElementById('dashWeather').innerText = w;
                    save(); 
                };
                el.appendChild(div);
            }
        }
        
        // Start App
        initApp();
    </script>
</body>
</html>
