<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <title>Hokkaido V25 Final</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --fuji-teal: #2A4B55; --fuji-red: #B54B4B; --fuji-gold: #D4AF37; --text-dark: #1a1a1a;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --glass-blur: blur(20px);
            --slot-height: 60px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'M PLUS Rounded 1c', sans-serif !important; }
        
        html {
            width: 100%;
            height: 100%;
            overscroll-behavior: none; 
        }
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            color: var(--text-dark); 
            padding-bottom: 110px; 
            overflow-x: hidden; 
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: #f0f2f5;
            background: url('mailbox.png') no-repeat center center fixed; 
            background-size: cover; 
        }
        
        .glass-panel { background: var(--glass-bg); backdrop-filter: var(--glass-blur); border: var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 24px; }
        
        /* --- 1. SNOW LOWERED 1cm (Approx 38px down from -25px) --- */
        .snow-topper { position: relative; overflow: visible !important; }
        .snow-topper::after {
            content: ''; 
            position: absolute; 
            /* Set to positive 12px to push it down onto the block */
            top: 14px; 
            right: 0; 
            width: 33%; 
            height: 50px;
            background: url('snow.png'); 
            background-repeat: no-repeat; 
            background-position: top right;
            background-size: 100% auto; 
            pointer-events: none; 
            z-index: 50;
        }

        .app-header { position: sticky; top: 10px; z-index: 1000; margin: 0 15px 15px 15px; padding: 15px; text-align: center; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border-radius: 16px; box-shadow: var(--glass-shadow); }
        .app-title { font-size: 17px; font-weight: 800; color: var(--fuji-teal); letter-spacing: 0.5px; }
        
        .plan-sticky-header { position: sticky; top: 75px; z-index: 900; margin: 0 -10px; padding: 0 10px 5px 10px; backdrop-filter: blur(5px); }
        
        .dashboard-container { margin: 15px 15px; height: auto; min-height: 180px; border-radius: 24px; overflow: hidden; position: relative; background: url('tree.png') no-repeat center right; background-size: cover; color: var(--text-dark); border: 2px solid rgba(255,255,255,0.5); box-shadow: var(--glass-shadow); transition: 0.3s; }
        .dash-overlay { padding: 20px; display: flex; flex-direction: column; justify-content: space-between; min-height: 180px; gap: 8px; }
        .dash-content { display: flex; flex-direction: column; align-items: flex-start; max-width: 65%; }
        
        .dash-loc { font-size: 22px; font-weight: 800; color: #111; line-height: 1.1; margin-bottom: 4px; text-shadow: 0 2px 10px rgba(255,255,255,0.8); }
        .dash-sub { font-size: 18px; font-weight: 800; color: var(--fuji-teal); white-space: nowrap; display: flex; align-items: center; gap: 6px; text-shadow: 0 2px 10px rgba(255,255,255,0.8); }
        .dash-attraction { font-size: 13px; font-weight: 700; color: #444; margin-top: 6px; background: rgba(255,255,255,0.7); padding: 4px 10px; border-radius: 10px; backdrop-filter: blur(5px); display: inline-block; }

        .dash-rate { background: rgba(255,255,255,0.9); padding: 6px 10px; border-radius: 10px; font-size: 12px; font-weight: 800; display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: var(--fuji-teal); backdrop-filter: blur(10px); margin-right: 5px; }
        .dash-map-btn { background: var(--fuji-teal); color: white; padding: 6px 12px; border-radius: 10px; font-size: 12px; font-weight: 800; display: inline-block; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.2s; white-space: nowrap; }
        .dash-map-btn.nav-mode { background: var(--fuji-red); }
        
        .dash-map { display: none; width: 100%; height: 100%; border: none; min-height: 200px; }
        .close-map { position: absolute; top: 15px; right: 15px; background: var(--fuji-red); color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight:bold; cursor: pointer; display: none; z-index: 50; }

        .date-strip { overflow-x: auto; white-space: nowrap; padding: 0 15px; margin-bottom: 10px; scrollbar-width: none; }
        .date-pill { display: inline-block; padding: 12px 18px; margin-right: 8px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-radius: 16px; color: #666; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; min-width: 100px; border: 1px solid rgba(255,255,255,0.3); }
        .date-pill.active { background: var(--fuji-teal); color: #fff; transform: scale(1.05); box-shadow: 0 8px 20px rgba(42, 75, 85, 0.3); }
        .d-wk { font-size: 13px; font-weight: 800; margin-bottom: 2px; }

        .hotel-bar { margin: 15px; padding: 12px; text-align: center; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 20px; border: var(--glass-border); box-shadow: var(--glass-shadow); display: flex; flex-direction: column; gap: 4px; align-items: center; justify-content: center; min-height: 70px; }
        .hotel-name { font-weight: 800; font-size: 14px; color: var(--fuji-teal); }
        .hotel-map-link { font-size: 11px; color: var(--fuji-red); text-decoration: none; font-weight: 700; background: rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 8px; margin-top: 4px; display: inline-block; }

        .timeline-block { margin: 15px; padding: 20px 0; min-height: 500px; overflow: visible; position: relative; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; border: var(--glass-border); box-shadow: var(--glass-shadow); }
        .time-axis { position: absolute; left: 0; top: 20px; bottom: 20px; width: 70px; border-right: 2px dashed rgba(0,0,0,0.1); }
        .events-area { margin-left: 70px; position: relative; min-height: 100%; }
        .time-slot { height: var(--slot-height); position: relative; }
        .ts-label { position: absolute; right: 10px; top: -10px; font-size: 11px; font-weight:800; color: #888; background: rgba(255,255,255,0.8); padding: 2px 5px; border-radius: 6px; }
        
        .sun-marker-axis { position: absolute; left: 5px; right: 5px; height: 1px; border-top: 2px dotted var(--fuji-gold); z-index: 5; pointer-events: none; }
        .sun-text-axis { position: absolute; left: 0; top: -18px; width: 100%; text-align: center; font-size: 9px; background: #fff; border-radius: 4px; color: var(--fuji-gold); font-weight: bold; padding: 1px; border: 1px solid var(--fuji-gold); }

        .now-line { position: absolute; left: 0; right: 0; height: 2px; background: var(--fuji-red); z-index: 50; pointer-events: none; }
        .now-line::before { content: 'NOW'; position: absolute; left: -50px; top: -8px; width: 45px; text-align:right; color: var(--fuji-red); font-size: 10px; font-weight: 800; }
        .now-line::after { content: ''; position: absolute; left: -4px; top: -3px; width: 8px; height: 8px; background: var(--fuji-red); border-radius: 50%; }

        .t-event { position: absolute; left: 10px; right: 15px; background: rgba(244, 242, 233, 0.95); border-radius: 12px; padding: 6px 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); z-index: 10; cursor: pointer; border: 1px solid rgba(0,0,0,0.05); }
        .t-title { font-weight: 800; font-size: 13px; color: var(--fuji-teal); margin-bottom: 2px; line-height: 1.1; }
        .t-loc { font-size: 10px; color: #666; }
        .card-edit-btn { position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--fuji-teal); cursor: pointer; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .chart-card { padding: 20px; margin: 15px; background: var(--glass-bg); backdrop-filter: var(--glass-blur); border-radius: 24px; border: var(--glass-border); box-shadow: var(--glass-shadow); }
        .exp-group-title { margin: 15px 15px 8px 15px; font-size: 13px; font-weight: 800; color: var(--fuji-teal); opacity: 0.8; letter-spacing: 0.5px; border-bottom: 2px solid rgba(42, 75, 85, 0.1); padding-bottom: 4px; }
        .exp-block { padding: 14px; margin: 0 15px 8px 15px; display: flex; justify-content: space-between; align-items: center; position: relative; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        
        /* --- 2. EXPENSE ALIGNMENT FIX --- */
        .exp-left { flex: 1; }
        .exp-right { text-align: right; min-width: 80px; margin-left: auto; }
        
        .exp-cat { font-size: 14px; font-weight: 800; color: var(--fuji-teal); }
        .exp-item { font-size: 12px; color: #444; font-weight: 600; }
        .exp-pay { font-size: 10px; color: var(--fuji-red); background:#fff0f0; padding:2px 6px; border-radius:4px; margin-left:5px; }
        .exp-amt { font-size: 15px; font-weight: 800; color: #111; letter-spacing: -0.5px; display: block; }
        .exp-avg { font-size: 10px; color: #666; margin-top: 2px; display: block; }
        .pie-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; }
        .legend-item { font-size: 10px; display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

        .pool-card { margin-top: 15px; border-top: 2px dashed rgba(42, 75, 85, 0.2); padding-top: 15px; }
        .pool-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 12px; }
        .pool-label { font-weight: bold; color: #666; }
        .pool-val { font-weight: 800; color: var(--fuji-teal); }
        .pool-rem { color: var(--fuji-red); font-size: 14px; }
        
        .btn-pool-edit { padding: 4px 10px; font-size: 11px; white-space: nowrap; border-radius: 12px; background: #eee; color: #555; border: none; font-weight: 800; width: fit-content; }

        .settle-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        .settle-table th { text-align: left; color: #666; padding-bottom: 8px; font-weight: normal; }
        .settle-table td { padding: 6px 0; border-top: 1px dashed rgba(0,0,0,0.1); font-weight: bold; }
        .money-pos { color: var(--fuji-red); } .money-neg { color: var(--fuji-teal); }

        .pack-cat-header { margin: 20px 15px 10px 15px; font-size: 16px; font-weight: 800; color: var(--fuji-teal); background: rgba(255,255,255,0.6); padding: 8px 12px; border-radius: 12px; display: inline-block; }
        .pack-item { padding: 12px 15px; margin: 0 15px 8px 15px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: var(--glass-shadow); display: flex; flex-direction: column; gap: 8px; }
        .pack-row-top { display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: #333; font-size: 14px; }
        .pack-row-checks { display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap; }
        .p-bubble { padding: 4px 10px; border-radius: 14px; border: 1px solid #ddd; background: #fff; color: #ccc; font-size: 10px; font-weight: 800; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; min-width: 40px; }
        .p-bubble.checked { background: var(--fuji-teal); color: white; border-color: var(--fuji-teal); }

        .progress-container { margin: 0 15px 15px 15px; background: rgba(255,255,255,0.5); height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--fuji-teal); width: 0%; transition: width 0.5s ease; }
        .progress-text { margin: 0 15px 5px 15px; font-size: 20px; font-weight: 800; color: var(--fuji-teal); text-align: center; letter-spacing: 1px; }

        .nav-container { position: fixed; bottom: 25px; left: 20px; right: 20px; height: 75px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 24px; display: flex; justify-content: space-around; align-items: center; z-index: 2000; padding: 0 10px; border: 1px solid rgba(255,255,255,0.5); box-shadow: none !important; }
        .nav-btn { text-align: center; color: #999; font-size: 10px; font-weight: 700; flex: 1; transition: 0.3s; padding: 10px; border-radius: 16px; }
        .nav-btn.active { color: #666; background: transparent; transform: none; }
        .nav-btn.active .nav-icon { filter: grayscale(100%); opacity: 0.6; }
        .nav-icon { font-size: 28px; display: block; margin-bottom: 2px; }
        
        .fab { position: fixed; bottom: 120px; left: 25px; width: 60px; height: 60px; background: var(--fuji-red); color: white; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: var(--glass-shadow); z-index: 2100; cursor: pointer; transition: opacity 0.3s; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal.open { display: flex; }
        .modal-card { background: #fff; width: 85%; max-width: 400px; padding: 25px; border-radius: 24px; box-shadow: var(--shadow-float); animation: popUp 0.3s; max-height: 80vh; overflow-y: auto; }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .input-label { display: block; font-size: 12px; font-weight: 800; color: var(--fuji-teal); margin-bottom: 4px; margin-top: 10px; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 15px; background: #fff; font-family: inherit; color: var(--text-dark); font-weight: bold; margin-bottom: 0; }
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 14px; font-size: 15px; font-weight: 800; cursor: pointer; }
        .btn-primary { background: var(--fuji-teal); color: white; }
        .btn-sec { background: #f0f0f0; color: #555; }
        .page { display: none; }
        .page.active { display: block; }

        #confirmModal .modal-card { text-align: center; }
        .conf-msg { font-size: 16px; font-weight: 800; color: #333; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="app-header snow-topper"><div class="app-title">2026„ÅÆÂåóÊµ∑ÈÅìÈ£üË∂≥‰∏âÈ§ê‰πãÊóÖüß£</div></div>

    <div id="pg-plan" class="page active">
        <div class="plan-sticky-header">
            <div class="dashboard-container" id="dashboard">
                <div class="close-map" onclick="closeMap()">Close Map ‚úï</div>
                <div class="dash-overlay" id="dashInfo">
                    <div class="dash-content">
                        <div class="dash-loc" id="dashLoc">Loading...</div>
                        <div class="dash-sub" id="dashWeather">Loading...</div>
                        <div class="dash-attraction" id="dashHighlight">üìç Loading...</div>
                    </div>
                    <div>
                        <div class="dash-rate" id="dashRate">$100 JPY = $5.3 HKD</div>
                        <a href="https://maps.app.goo.gl/C7BTdCcFGdUTAscw5" target="_blank" class="dash-map-btn" id="mapBtn">üó∫Ô∏è Open Full Map</a>
                    </div>
                </div>
                <iframe class="dash-map" id="dashMapFrame" src=""></iframe>
            </div>
            <div class="date-strip" id="dateStrip"></div>
            <div class="hotel-bar" id="hotelBar">
                <div class="hotel-name">üè® Loading Hotel...</div>
            </div>
        </div>
        <div class="timeline-block snow-topper" id="timelineBlock"><div class="time-axis" id="timeAxis"></div><div class="events-area" id="eventsArea"></div></div>
    </div>

    <div id="pg-spend" class="page">
        <div class="chart-card">
            <div style="text-align:center; font-size:12px; font-weight:800; color:#666; letter-spacing:1px; margin-bottom:5px;">TOTAL SPENDING (HKD)</div>
            <div style="text-align:center; font-size:36px; font-weight:800; color:var(--text-dark);">$<span id="totalSpend">0</span></div>
            <div style="width:140px; height:140px; border-radius:50%; background:rgba(255,255,255,0.5); margin:15px auto; position:relative;" id="poolPie"></div>
            <div class="pie-legend" id="pieLegend"></div>
        </div>
        
        <div class="chart-card snow-topper">
            <div style="text-align:center; font-size:14px; font-weight:800; color:var(--fuji-teal); margin-bottom:15px;">SETTLEMENT</div>
            <div id="settlementTable"></div>
            <div class="pool-card">
                <div class="pool-row" style="margin-bottom:10px;">
                    <span style="font-size:14px; font-weight:800; color:var(--fuji-teal);">üèä POOL FUNDS</span>
                    <button class="btn-pool-edit" onclick="openModal('pool', null)">Edit Pool</button>
                </div>
                <div class="pool-row"><span class="pool-label">HKD Fund:</span><span class="pool-val" id="pHKD">$0</span></div>
                <div class="pool-row"><span class="pool-label">JPY Fund:</span><span class="pool-val" id="pJPY">¬•0</span></div>
                <div style="border-top:1px solid #eee; margin:5px 0;"></div>
                <div class="pool-row"><span class="pool-label">Rem (HKD):</span><span class="pool-val pool-rem" id="remHKD">$0</span></div>
                <div class="pool-row"><span class="pool-label">Rem (JPY):</span><span class="pool-val pool-rem" id="remJPY">¬•0</span></div>
            </div>
        </div>
        <div style="margin: 0 15px 15px 15px; font-size:16px; font-weight:800; color:var(--fuji-teal); letter-spacing:1px;">TRANSACTIONS</div>
        <div id="expenseList"></div>
    </div>

    <div id="pg-pack" class="page">
        <div style="margin:20px 15px 10px 15px; font-size:20px; font-weight:800; color:var(--fuji-teal);">üéí Packing List</div>
        
        <div class="progress-text" id="packText">Ready: 0%</div>
        <div class="progress-container"><div class="progress-fill" id="packFill"></div></div>

        <div class="snow-topper" style="margin:0 15px 15px 15px; background:white; padding:15px; border-radius:16px; box-shadow:var(--glass-shadow);">
            <select id="newPackCat" style="margin-bottom:10px;">
                <option value="Personal ID">Personal ID</option>
                <option value="Snowboard Gear">Snowboard Gear</option>
                <option value="Defeat Cold Items">Defeat Cold Items</option>
                <option value="Gadgets">Gadgets</option>
                <option value="Other">Other</option>
            </select>
            <div style="display:flex; gap:10px;">
                <input type="text" id="newPackItem" placeholder="Item name..." style="margin:0;">
                <button class="btn-primary" style="flex:0 0 60px;" onclick="addPackItem()">Add</button>
            </div>
        </div>
        <div id="packListContainer" style="padding-bottom: 30px;"></div>
    </div>

    <div class="nav-container">
        <div class="nav-btn active" onclick="nav('plan')"><span class="nav-icon">üóì</span>Trip Details</div>
        <div class="nav-btn" onclick="nav('spend')"><span class="nav-icon">üí¥</span>Expenses</div>
        <div class="nav-btn" onclick="nav('pack')"><span class="nav-icon">üéí</span>To Pack</div>
    </div>
    <div class="fab" id="mainFab" onclick="clickAdd()">+</div>

    <div class="modal" id="modal">
        <div class="modal-card">
            <h3 id="mTitle" style="margin-top:0; color:var(--fuji-teal);">Edit</h3>
            <input type="hidden" id="mId"><input type="hidden" id="mMode">
            
            <div id="fPlan" style="display:none;">
                <label class="input-label">Time</label>
                <div style="display:flex; gap:10px;"><input type="time" id="inpStart"><input type="time" id="inpEnd"></div>
                <label class="input-label">Activity</label>
                <input type="text" id="inpTitle" placeholder="Activity">
                <label class="input-label">Location</label>
                <input type="text" id="inpLoc" placeholder="Location (MapCode / Address)">
            </div>

            <div id="fSpend" style="display:none;">
                <label class="input-label">Category</label>
                <select id="spCat">
                    <option value="Food">Food üçî</option>
                    <option value="Transport">Transport üöÜ</option>
                    <option value="Hotel">Hotel üè®</option>
                    <option value="Attractions">Attractions üé°</option>
                    <option value="Shopping">Shopping üõç</option>
                    <option value="Other">Other üì¶</option>
                </select>
                <label class="input-label">Item</label>
                <input type="text" id="spItem" placeholder="Item Name">
                <label class="input-label">Amount</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="spAmt" placeholder="0.00">
                    <select id="spCurr" style="width:100px;"><option value="HKD">HKD</option><option value="JPY">JPY</option></select>
                </div>
                <label class="input-label">Payment Method</label>
                <select id="spMethod"><option value="Credit Card">Credit Card üí≥</option><option value="Cash">Cash üí¥</option><option value="Suica/IC">Suica/IC üêß</option><option value="Alipay">Alipay</option></select>
                <label class="input-label">Payer</label>
                <select id="spPayer">
                    <option value="Pool">Pool (Public Fund)</option>
                    <option value="Cho">Cho</option>
                    <option value="Dan">Dan</option>
                    <option value="Diaz">Diaz</option>
                    <option value="Skye">Skye</option>
                </select>
                <label class="input-label">Purpose</label>
                <select id="spType"><option value="Group">Group</option><option value="Personal">Personal</option></select>
            </div>

            <div id="fPool" style="display:none;">
                <label class="input-label">HKD Pool Fund</label>
                <input type="number" id="plHKD" placeholder="e.g. 20000">
                <label class="input-label">JPY Pool Fund</label>
                <input type="number" id="plJPY" placeholder="e.g. 100000">
                <div style="font-size:11px; color:#888; margin-top:5px;">Enter the total collected cash for each currency.</div>
            </div>

            <div class="btn-row"><button class="btn-sec" onclick="closeModal()">Cancel</button><button class="btn-primary" style="background:var(--fuji-red)" onclick="confirmDelete()" id="btnDel">Delete</button><button class="btn-primary" onclick="doSave()">Save</button></div>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-card">
            <h3 style="margin-top:0; color:var(--fuji-red);">Confirmation</h3>
            <div class="conf-msg">Are you sure you want to delete this item?</div>
            <div class="btn-row">
                <button class="btn-sec" onclick="closeConfirmModal()">No, Keep it</button>
                <button class="btn-primary" style="background:var(--fuji-red)" onclick="executeDelete()">Yes, Delete</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCywE_gs1H7-lw21_52hFwpT8mPjLS_8i8",
          authDomain: "hokkaido2026-5ad8b.firebaseapp.com",
          databaseURL: "https://hokkaido2026-5ad8b-default-rtdb.firebaseio.com/",
          projectId: "hokkaido2026-5ad8b",
          storageBucket: "hokkaido2026-5ad8b.firebasestorage.app",
          messagingSenderId: "542618426908",
          appId: "1:542618426908:web:b1d41b39375f788576c9d9"
        };
        
        let RATE = 0.053; 
        
        const HOTEL_INFO = {
            "2026-01-08": { name: "Â§öÁ±≥PREMIUMÈÖíÂ∫ó-Â∞èÊ®ΩÂ§©ÁÑ∂Ê∫´Ê≥â", code: "3 Chome-9-1 Inaho, 047-0032 Â∞èÊ®ΩÂ∏Ç" },
            "2026-01-09": { name: "Êú≠ÂπåÂ§ßÈÄöÂÖ¨ÂúíÊôØËßÄÈÖíÂ∫ó", code: "Odori Nishi 8-chome, 060-0042 Êú≠ÂπåÂ∏Ç" },
            "2026-01-10": { name: "Êú≠ÂπåÂ§ßÈÄöÂÖ¨ÂúíÊôØËßÄÈÖíÂ∫ó", code: "Odori Nishi 8-chome, 060-0042 Êú≠ÂπåÂ∏Ç" },
            "2026-01-11": { name: "ÂØåËâØÈáéÊãâÁ∂≠ÊñØÂ°îÊ∏©Ê≥âÈÖíÂ∫ó", code: "5-14 Asahimachi, 076-0026 ÂØåËâØÈáéÂ∏Ç" },
            "2026-01-12": { name: "ÂØåËâØÈáéÊãâÁ∂≠ÊñØÂ°îÊ∏©Ê≥âÈÖíÂ∫ó", code: "5-14 Asahimachi, 076-0026 ÂØåËâØÈáéÂ∏Ç" },
            "2026-01-13": { name: "Êó≠Â∑ùÁ´ôÂâçÊ∞∏ÂÆâÂúãÈöõÈÖíÂ∫ó", code: "7-3112, Miyashitadori, 070-0030 Êó≠Â∑ùÂ∏Ç" },
            "2026-01-14": { name: "Kamui‰πãÊπØLa VistaÈòøÂØíÂ∑ù", code: "Okurushube Akancho 3-1, 085-0468 ÈáßË∑ØÂ∏Ç" },
            "2026-01-15": { name: "Kamui‰πãÊπØLa VistaÈòøÂØíÂ∑ù", code: "Okurushube Akancho 3-1, 085-0468 ÈáßË∑ØÂ∏Ç" },
            "2026-01-16": { name: "Áí∞ÁêÉÊôØËßÄÈÖíÂ∫óÈáßË∑Ø", code: "Suehitro-cho 13 jo, 085-0014 ÈáßË∑ØÂ∏Ç" },
            "2026-01-17": { name: "Êú≠ÂπåÁéãÂ≠êÈÖíÂ∫ó", code: "11 Chome Minami 2 Jonishi, 060-8615 Êú≠ÂπåÂ∏Ç" },
            "2026-01-18": { name: "Home Sweet Home", code: "Hong Kong" }
        };

        const COORDINATES = {
            "2026-01-08": { lat: 43.19, lon: 140.99 }, "2026-01-09": { lat: 43.19, lon: 140.99 },
            "2026-01-10": { lat: 43.06, lon: 141.35 }, "2026-01-11": { lat: 43.34, lon: 142.38 },
            "2026-01-12": { lat: 43.34, lon: 142.38 }, "2026-01-13": { lat: 43.59, lon: 142.46 },
            "2026-01-14": { lat: 43.77, lon: 142.36 }, "2026-01-15": { lat: 43.43, lon: 144.09 },
            "2026-01-16": { lat: 42.98, lon: 144.38 }, "2026-01-17": { lat: 43.06, lon: 141.35 },
            "2026-01-18": { lat: 43.06, lon: 141.35 }
        };

        const PEOPLE=['Cho','Dan','Diaz','Skye'];
        const CATEGORIES = ["Food", "Transport", "Hotel", "Attractions", "Shopping", "Other"];
        const PACK_CATEGORIES = ["Personal ID", "Snowboard Gear", "Defeat Cold Items", "Gadgets", "Other"];
        const CAT_COLORS = {'Food':'#FF9500', 'Transport':'#5856D6', 'Hotel':'#FF2D55', 'Attractions':'#AF52DE', 'Shopping':'#30B0C7', 'Other':'#888'};

        const rawSch = [
            ["2026-01-08", "05:30", "06:30", "Âá∫ÁôºÊ©üÂ†¥üõ´", "HK Home"], ["2026-01-08", "06:30", "09:00", "Âà∞Ê©üÂ†¥üõ´", "HKG"], ["2026-01-08", "09:00", "15:30", "HB008 HKG - CTS ‚úàÔ∏è", "Flight"], ["2026-01-08", "15:30", "16:30", "ÊîûË°åÊùéüß≥", "CTS"], ["2026-01-08", "16:30", "17:30", "ÊîûËªäüöó", "CTS"], ["2026-01-08", "17:30", "19:00", "ÈñãËªäÂà∞Â∞èÊ®Ωü´ô", "Drive"], ["2026-01-08", "19:00", "20:00", "ÊôöÈ§ê (ÊîøÂ£ΩÂè∏üç£)", "Otaru"], ["2026-01-08", "20:00", "21:00", "check inÈÖíÂ∫ó", "Otaru"], ["2026-01-08", "21:00", "22:00", "Â§©ÁãóÂ±±Â§úÊôØüåõ", "Tenguyama"],
            ["2026-01-09", "08:00", "12:30", "ÊãçÁÖßüì∑", "Otaru Canal"], ["2026-01-09", "12:30", "14:00", "ÂçàÈ§êüç±", "Otaru"], ["2026-01-09", "14:00", "18:00", "Â∞èÊ®Ω9ÈÄõüõçÔ∏è", "Sakaimachi"], ["2026-01-09", "18:00", "19:30", "ÈñãËªäÂà∞Êú≠Âπå", "Drive"], ["2026-01-09", "19:30", "21:00", "ÊôöÈ§ê (Áâõ‰πÉÂÆ∂üçú)", "Sapporo"], ["2026-01-09", "21:00", "22:00", "check in & ‰ºëÊÅØ", "Sapporo"],
            ["2026-01-10", "09:30", "12:30", "ÁôΩ‰πãÊàÄ‰∫∫ÂçöÁâ©È§®üç™", "Sapporo"], ["2026-01-10", "12:30", "14:30", "ÂçàÈ§ê(ËüπÈÅä‰∫≠ü¶Ä)", "Sapporo"], ["2026-01-10", "15:00", "17:30", "Êú≠ÂπåÂï§ÈÖíÂçöÁâ©È§®üç∫", "Sapporo"], ["2026-01-10", "19:00", "21:00", "ÊôöÈ§ê(ÂÜ∞Èõ™‰πãÈñÄü¶Ä)", "Sapporo"],
            ["2026-01-11", "09:00", "11:30", "ÈñãËªäÂà∞ÂØåËâØÈáéüöó", "Drive"], ["2026-01-11", "12:30", "14:00", "ÂçàÈ§êüç±", "Furano"], ["2026-01-11", "14:30", "17:30", "Â≠∏ÊªëÈõ™ & ÈÅ©ÊáâÈõ™Â†¥‚õ∑Ô∏è", "Furano Ski"], ["2026-01-11", "18:00", "19:30", "Á≤æÈùàÈú≤Âè∞üßö‚Äç‚ôÄÔ∏è", "Ningle Terrace"], ["2026-01-11", "19:30", "21:00", "ÊôöÈ§êü•ò", "Furano"],
            ["2026-01-12", "09:00", "17:00", "ÊªëÈõ™‚õ∑Ô∏è", "Furano Ski"], ["2026-01-12", "18:00", "19:00", "ÊôöÈ§êü•ò", "Furano"],
            ["2026-01-13", "08:30", "09:30", "ÈñãËªäÂà∞ÁæéÁëõüöó", "Drive"], ["2026-01-13", "09:30", "10:30", "ËÅñË™ïÊ®πüéÑ", "Biei"], ["2026-01-13", "10:30", "11:30", "Mild Seven Hillsüå≤", "Biei"], ["2026-01-13", "11:30", "13:30", "ÁæéÁëõ„ÅÆÊ£Æ KONON", "Cafe"], ["2026-01-13", "13:30", "14:30", "ÂõõÂ≠£ÂΩ©‰πã‰∏òüå∏", "Biei"], ["2026-01-13", "14:30", "15:30", "Ê∏ÖÊ±†/ÁÄëÂ∏Éüíß", "Blue Pond"], ["2026-01-13", "16:30", "17:30", "Êó≠Â∑ù (Check in)", "Asahikawa"], ["2026-01-13", "18:00", "20:00", "ÊôöÈ§ê(ÊàêÂêâÊÄùÊ±óÂ§ßÈªëÂ±ã)ü•©", "Asahikawa"],
            ["2026-01-14", "09:30", "12:00", "Êó≠Â∑ùÂãïÁâ©Âúíüêß", "Asahiyama"], ["2026-01-14", "12:00", "16:00", "ÂéªÈòøÂØíÊπñüöó", "Drive"], ["2026-01-14", "16:30", "23:00", "Ê∫´Ê≥âÊóÖÈ§®‰ºëÊÅØ & ÂòÜ‚ô®Ô∏è", "La Vista"],
            ["2026-01-15", "09:30", "16:00", "ÈòøÂØíÊπñ (Activity)‚ùÑÔ∏è", "Lake Akan"], ["2026-01-15", "16:30", "23:00", "Ê∫´Ê≥âÊóÖÈ§®‰ºëÊÅØ & ÂòÜ‚ô®Ô∏è", "La Vista"],
            ["2026-01-16", "10:00", "10:30", "check outÈÖíÂ∫ó", "Akan"], ["2026-01-16", "10:30", "13:00", "Âá∫ÁôºÂéªÂéöÂ≤∏üöó", "Drive"], ["2026-01-16", "13:00", "14:30", "ü¶™Ë†î (ÂéöÂ≤∏Ë†î)", "Akkeshi"], ["2026-01-16", "14:30", "16:00", "ÂΩ±Êó•ËêΩüåÖ", "Kushiro"], ["2026-01-16", "16:00", "17:30", "Âá∫ÁôºÂ∑ùË∑Ø", "Drive"], ["2026-01-16", "17:30", "19:00", "ÊôöÈ§êü•ò", "Kushiro"],
            ["2026-01-17", "09:00", "13:00", "ÈñãÂéªÊú≠Âπåüöó", "Drive"], ["2026-01-17", "13:00", "14:30", "ÂçàÈ§êüç±", "Sapporo"], ["2026-01-17", "16:00", "20:00", "Êú≠Âπå City / ShoppingüõçÔ∏è", "Sapporo"], ["2026-01-17", "20:00", "21:30", "ÊôöÈ§êü•ò", "Sapporo"],
            ["2026-01-18", "09:00", "13:00", "ÈñãÂéªÊ©üÂ†¥üöó", "Drive"], ["2026-01-18", "13:00", "14:00", "ÈÇÑËªäüöóÔºàÊàêÁî∞Ê©üÂ†¥?)", "Rental"], ["2026-01-18", "16:00", "21:00", "HB008 HKG - CTS ‚úàÔ∏è", "Flight"]
        ];

        const rawExp = [
            { id:1, item:"Hotel: Â§öÁ±≥PREMIUMÈÖíÂ∫ó (Otaru)", amount:1327.36, curr:"HKD", payer:"Cho", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:2, item:"Hotel: Êú≠ÂπåÂ§ßÈÄöÂÖ¨ÂúíÊôØËßÄÈÖíÂ∫ó (2N)", amount:2449.40, curr:"HKD", payer:"Cho", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:3, item:"Hotel: ÂØåËâØÈáéÊãâÁ∂≠ÊñØÂ°îÊ∏©Ê≥âÈÖíÂ∫ó (2N)", amount:6551.40, curr:"HKD", payer:"Cho", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:4, item:"Hotel: Êó≠Â∑ùÁ´ôÂâçÊ∞∏ÂÆâÂúãÈöõÈÖíÂ∫ó", amount:918.44, curr:"HKD", payer:"Cho", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:5, item:"Hotel: Kamui‰πãÊπØLa VistaÈòøÂØíÂ∑ù (2N)", amount:0, curr:"HKD", payer:"Cho", cat:"Hotel", type:"Group", method:"Pay at Hotel" },
            { id:6, item:"Hotel: Áí∞ÁêÉÊôØËßÄÈÖíÂ∫óÈáßË∑Ø", amount:867.58, curr:"HKD", payer:"Cho", cat:"Hotel", type:"Group", method:"Credit Card" },
            { id:7, item:"Hotel: Êú≠ÂπåÁéãÂ≠êÈÖíÂ∫ó", amount:2235.14, curr:"HKD", payer:"Cho", cat:"Hotel", type:"Group", method:"Credit Card" }
        ];

        const DEFAULT_PACK = [
            {id:1, cat:"Personal ID", text:"Passport üõÇ", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:2, cat:"Personal ID", text:"Driving License (Intl) üöó", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:3, cat:"Personal ID", text:"Credit Cards / Cash üí¥", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:4, cat:"Personal ID", text:"Insurance Policy üè•", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:5, cat:"Snowboard Gear", text:"Snowboard üèÇ", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:6, cat:"Snowboard Gear", text:"Boots üë¢", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:7, cat:"Snowboard Gear", text:"Bindings", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:8, cat:"Snowboard Gear", text:"Helmet ü™ñ", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:9, cat:"Snowboard Gear", text:"Goggles (Low/High Light) ü•Ω", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:10, cat:"Snowboard Gear", text:"Gloves (Waterproof) üß§", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:11, cat:"Snowboard Gear", text:"Impact Shorts / Knee Pads", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:12, cat:"Snowboard Gear", text:"Balaclava / Neck Warmer üß£", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:13, cat:"Defeat Cold Items", text:"Base Layer (Top/Bottom) üëï", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:14, cat:"Defeat Cold Items", text:"Mid Layer (Fleece/Down) üß•", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:15, cat:"Defeat Cold Items", text:"Snow Socks (Thick) üß¶", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:16, cat:"Defeat Cold Items", text:"Heat Packs (Hand/Toe) üî•", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:17, cat:"Defeat Cold Items", text:"Beanie / Hat üß¢", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:18, cat:"Gadgets", text:"Power Bank üîã", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:19, cat:"Gadgets", text:"Travel Adapter üîå", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:20, cat:"Gadgets", text:"Sim Card / Roaming", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:21, cat:"Gadgets", text:"GoPro / Camera üì∑", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:22, cat:"Other", text:"Skin Care (Moisturizer) üß¥", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:23, cat:"Other", text:"Lip Balm (SPF) üíÑ", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:24, cat:"Other", text:"Painkillers / Meds üíä", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}},
            {id:25, cat:"Other", text:"Sunglasses üòé", checks:{Cho:false,Dan:false,Diaz:false,Skye:false}}
        ];
        
        let appData = { 
            currDate:"2026-01-08", 
            schedule: rawSch.map((s,i)=>({id:i,date:s[0],start:s[1],end:s[2],title:s[3],loc:s[4]})), 
            expenses: rawExp, 
            packList: DEFAULT_PACK,
            poolHKD: 0,
            poolJPY: 0
        };
        
        let dbRef = null;

        function initApp() {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            dbRef = db.ref('hokkaido_v25_refine_4'); 
            
            dbRef.on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    appData = val; 
                    refresh();
                } else {
                    save();
                }
            });
            fetchCurrency();
            initSwipe();
        }

        async function fetchCurrency() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                if(data && data.rates && data.rates.HKD) {
                    RATE = data.rates.HKD;
                    const displayRate = (100 * RATE).toFixed(1);
                    document.getElementById('dashRate').innerText = `$100 JPY = $${displayRate} HKD`;
                }
            } catch (e) { console.log("Currency error"); }
        }

        function save() {
            if (dbRef) dbRef.set(appData);
        }

        const fmtMoney=(n)=>n.toLocaleString('en-US',{minimumFractionDigits:1,maximumFractionDigits:1});
        const SLOT_HEIGHT=60;

        function initSwipe(){
            const el = document.getElementById('timelineBlock');
            let startX = 0;
            el.addEventListener('touchstart', e => { startX = e.changedTouches[0].screenX; }, false);
            el.addEventListener('touchend', e => {
                let endX = e.changedTouches[0].screenX;
                handleSwipe(startX, endX);
            }, false);
        }

        function handleSwipe(start, end){
            const threshold = 50; 
            if(end < start - threshold) changeDate(1);
            else if(end > start + threshold) changeDate(-1);
        }

        function changeDate(offset){
            const dates = [];
            for(let i=8;i<=18;i++){ dates.push(`2026-01-${i<10?'0'+i:i}`); }
            const idx = dates.indexOf(appData.currDate);
            if(idx !== -1){
                const newIdx = idx + offset;
                if(newIdx >= 0 && newIdx < dates.length){
                    appData.currDate = dates[newIdx];
                    closeMap();
                    refresh();
                }
            }
        }

        function refresh(){
            renderDates();
            renderTimeline();
            renderExpenses(); 
            renderPackList();
            
            updateDashboardLocation();
            
            const h = HOTEL_INFO[appData.currDate];
            if (h) {
                const mapLink = h.code.includes("MapCode") || h.code.includes("Address") ? `https://maps.google.com/maps?q=${encodeURIComponent(h.code)}` : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name + ' Hokkaido')}`;
                document.getElementById('hotelBar').innerHTML = `
                    <div class="hotel-name">üè® ${h.name}</div>
                    <a href="${mapLink}" target="_blank" class="hotel-map-link">üìç ${h.code}</a>
                `;
            } else {
                document.getElementById('hotelBar').innerHTML = '<div>üè® No Hotel</div>';
            }
            fetchWeather(appData.currDate);
        }

        function updateDashboardLocation() {
            const dailySched = appData.schedule.filter(e => e.date === appData.currDate);
            if (dailySched.length > 0) {
                const mainItem = dailySched.find(e => e.start > "10:00" && e.start < "18:00") || dailySched[0];
                document.getElementById('dashLoc').innerText = mainItem.loc;
                document.getElementById('dashHighlight').innerText = "üìç " + mainItem.title;
                const searchQ = mainItem.loc + " Hokkaido";
                document.getElementById('dashMapFrame').src=`https://maps.google.com/maps?q=${encodeURIComponent(searchQ)}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
                const btn = document.getElementById('mapBtn');
                btn.href = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(mainItem.loc + " Hokkaido")}`;
                btn.innerText = "üìç Navigate Here";
                btn.classList.add('nav-mode');
            } else {
                document.getElementById('dashLoc').innerText = "Free Day";
                document.getElementById('dashHighlight').innerText = "Relax";
            }
        }

        function fetchWeather(dateStr) {
            const coords = COORDINATES[dateStr];
            if(!coords) return;
            const wIcons = ["‚ùÑÔ∏è","üå•Ô∏è","üå®Ô∏è","üå§Ô∏è"];
            const rIcon = wIcons[Math.floor(Math.random()*wIcons.length)];
            const high = -2 - Math.floor(Math.random()*5);
            const low = -8 - Math.floor(Math.random()*8);
            document.getElementById('dashWeather').innerHTML = `${rIcon} ${high}¬∞ / ${low}¬∞ Snow`;
        }

        function renderTimeline(){
            const ax=document.getElementById('timeAxis'), ar=document.getElementById('eventsArea');
            ax.innerHTML='';ar.innerHTML='';
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const dStr = String(now.getDate()).padStart(2, '0');
            const todayStr = `${y}-${m}-${dStr}`;

            for(let i=5;i<=24;i++){
                const d=document.createElement('div');d.className='time-slot';
                const label = `${i.toString().padStart(2, '0')}:00`;
                d.innerHTML=`<div class="ts-label">${label}</div>`;ax.appendChild(d);
                const li=document.createElement('div');li.className='time-slot';li.style.borderBottom='1px dashed rgba(0,0,0,0.1)';ar.appendChild(li);
            }
            if(appData.schedule) {
                appData.schedule.filter(e=>e.date===appData.currDate).forEach(e=>{
                    const sH=parseInt(e.start.split(':')[0]), sM=parseInt(e.start.split(':')[1]);
                    const eH=parseInt(e.end.split(':')[0]), eM=parseInt(e.end.split(':')[1]);
                    const st=(sH-5)*60+sM; const du=((eH-5)*60+eM)-st;
                    const top=(st/60)*SLOT_HEIGHT; const h=(du/60)*SLOT_HEIGHT;
                    if(top>=0){
                        const el=document.createElement('div');el.className='t-event';el.style.top=(top+5)+'px';el.style.height=(h>25?h-5:25)+'px';
                        el.innerHTML=`<div class="t-title">${e.title}</div><div class="t-loc">üìç ${e.loc}</div><div class="card-edit-btn" onclick="editEvent(event,${e.id})">‚úé</div>`;
                        el.onclick=()=>showMap(e.loc);ar.appendChild(el);
                    }
                });
            }
            if(appData.currDate === todayStr) {
                const curH = now.getHours();
                const curM = now.getMinutes();
                if(curH >= 5) {
                    const min = (curH - 5)*60 + curM;
                    const top = (min/60)*SLOT_HEIGHT;
                    const line = document.createElement('div');
                    line.className = 'now-line';
                    line.style.top = top + 'px';
                    ar.appendChild(line);
                }
            }
            addSun(ax,"07:06","üåÖ");addSun(ax,"16:20","üåá");
        }
        function addSun(c,t,i){const h=parseInt(t.split(':')[0]),m=parseInt(t.split(':')[1]);const mn=(h-5)*60+m;const tp=(mn/60)*SLOT_HEIGHT;if(tp>0){const d=document.createElement('div');d.className='sun-marker-axis';d.style.top=tp+'px';d.innerHTML=`<div class="sun-text-axis">${i} ${t}</div>`;c.appendChild(d);}}

        function renderExpenses(){
            const l=document.getElementById('expenseList');l.innerHTML='';
            let tg=0; let pb={'Cho':0,'Dan':0,'Diaz':0,'Skye':0}; let catTotals={};
            
            let poolPaidHKD = 0;
            let poolPaidJPY = 0;

            if(appData.expenses) {
                appData.expenses.forEach(e=>{
                    let vHKD = e.curr==='JPY' ? e.amount*RATE : e.amount;
                    
                    if(e.payer === 'Pool'){
                        if(e.curr === 'HKD') poolPaidHKD += e.amount;
                        else if(e.curr === 'JPY') poolPaidJPY += e.amount;
                    } 
                    else if(e.type==='Group'){ 
                        tg+=vHKD; 
                        if(pb[e.payer]!==undefined) pb[e.payer]+=vHKD; 
                    }
                    
                    if(e.cat) { 
                        catTotals[e.cat] = (catTotals[e.cat] || 0) + vHKD;
                    }
                });
            }

            const pHKD = parseFloat(appData.poolHKD || 0);
            const pJPY = parseFloat(appData.poolJPY || 0);
            
            document.getElementById('pHKD').innerText = '$' + fmtMoney(pHKD);
            document.getElementById('pJPY').innerText = '¬•' + fmtMoney(pJPY);
            document.getElementById('remHKD').innerText = '$' + fmtMoney(pHKD - poolPaidHKD);
            document.getElementById('remJPY').innerText = '¬•' + fmtMoney(pJPY - poolPaidJPY);

            CATEGORIES.forEach(cat => {
                const items = appData.expenses ? appData.expenses.filter(e => e.cat === cat) : [];
                if (items.length > 0) {
                    const groupTitle = document.createElement('div');
                    groupTitle.className = 'exp-group-title';
                    const icon = cat==='Food'?'üçî':cat==='Transport'?'üöÜ':cat==='Hotel'?'üè®':cat==='Attractions'?'üé°':cat==='Shopping'?'üõçÔ∏è':'üì¶';
                    groupTitle.innerText = `${icon} ${cat}`;
                    l.appendChild(groupTitle);
                    items.forEach(e => {
                        const d=document.createElement('div');d.className='exp-block';
                        d.innerHTML=`<div class="exp-left"><div class="exp-item">${e.item}<span class="exp-pay">${e.method||'-'}</span></div></div><div class="exp-right"><div class="exp-amt">$${e.curr} ${fmtMoney(e.amount)}</div><div class="exp-avg">${e.payer} Paid</div></div><div class="card-edit-btn" style="position:static;margin-left:10px;width:30px;height:30px;" onclick="editExp(${e.id})">‚úé</div>`;
                        l.appendChild(d);
                    });
                }
            });
            
            let poolSpentInHKD = poolPaidHKD + (poolPaidJPY * RATE);
            let totalSpendingForDisplay = tg + poolSpentInHKD;

            let pieTotal = 0;
            for(let k in catTotals) pieTotal += catTotals[k];

            document.getElementById('totalSpend').innerText=fmtMoney(totalSpendingForDisplay); 
            renderPie(catTotals, pieTotal); 
            renderSettlement(tg,pb);
        }

        function renderSettlement(t,pb){
            const tb=document.getElementById('settlementTable'); const s=t/4;
            let h=`<table class="settle-table"><thead><tr><th>Person</th><th>Share</th><th>Paid</th><th>Bal (+Owe/-Get)</th></tr></thead><tbody>`;
            PEOPLE.forEach(p=>{
                const pd=pb[p]; const b=s-pd; const cl=b>0?'money-pos':'money-neg';
                const tx=b>0?`HK$${fmtMoney(b)}`:`(HK$${fmtMoney(Math.abs(b))})`;
                h+=`<tr><td>${p}</td><td>$${fmtMoney(s)}</td><td>$${fmtMoney(pd)}</td><td class="${cl}">${tx}</td></tr>`;
            });
            h+=`</tbody></table>`; tb.innerHTML=h;
        }

        function renderPie(c,t){
            let d=0,css=[],i=0;
            const legendEl = document.getElementById('pieLegend'); legendEl.innerHTML='';
            if (t <= 0) { document.getElementById('poolPie').style.background = '#eee'; return; }
            for(let k in c){
                if(c[k]>0){
                    let p=(c[k]/t)*360;
                    const col = CAT_COLORS[k] || '#999';
                    css.push(`${col} ${d}deg ${d+p}deg`);
                    d+=p;
                    legendEl.innerHTML += `<div class="legend-item"><div class="dot" style="background:${col}"></div>${k} (${Math.round((c[k]/t)*100)}%)</div>`;
                }
            }
            if(css.length > 0) document.getElementById('poolPie').style.background=`conic-gradient(${css.join(',')})`;
        }

        function renderPackList(){
            const c=document.getElementById('packListContainer'); c.innerHTML='';
            if(!appData.packList) return;
            
            let totalChecks = 0;
            let totalItems = 0;

            PACK_CATEGORIES.forEach(cat => {
                const items = appData.packList.filter(i => i.cat === cat);
                if(items.length > 0){
                    const header = document.createElement('div');
                    header.className = 'pack-cat-header';
                    header.innerText = cat;
                    c.appendChild(header);
                    
                    items.forEach((item) => {
                        totalItems += 4; 
                        
                        const d = document.createElement('div');
                        d.className = 'pack-item';
                        let html = `<div class="pack-row-top"><span>${item.text}</span><span style="color:#e74c3c;cursor:pointer;" onclick="confirmPackDelete(${item.id})">√ó</span></div>`;
                        html += `<div class="pack-row-checks">`;
                        
                        PEOPLE.forEach(p => {
                            const isChecked = item.checks && item.checks[p];
                            if(isChecked) totalChecks++;
                            html += `<div class="p-bubble ${isChecked ? 'checked' : ''}" onclick="togPack(${item.id}, '${p}')">${p}</div>`;
                        });
                        html += `</div>`;
                        d.innerHTML = html;
                        c.appendChild(d);
                    });
                }
            });

            const pct = totalItems > 0 ? Math.round((totalChecks / totalItems)*100) : 0;
            document.getElementById('packFill').style.width = pct + "%";
            document.getElementById('packText').innerText = `Ready: ${pct}%`;
        }
        
        function addPackItem(){
            const v=document.getElementById('newPackItem').value;
            const cat=document.getElementById('newPackCat').value;
            if(v){
                if(!appData.packList) appData.packList=[];
                appData.packList.push({id:Date.now(), cat:cat, text:v, checks:{Cho:false,Dan:false,Diaz:false,Skye:false}});
                save();
                document.getElementById('newPackItem').value='';
                renderPackList();
            }
        }
        
        function togPack(id, person){
            const item = appData.packList.find(x => x.id === id);
            if(item){
                if(!item.checks) item.checks = {Cho:false,Dan:false,Diaz:false,Skye:false};
                item.checks[person] = !item.checks[person];
                save();
                renderPackList(); 
            }
        }
        
        let deleteCallback = null;
        
        function confirmDelete(){
            if(!eId) return;
            deleteCallback = doDelete;
            document.getElementById('confirmModal').classList.add('open');
        }

        function confirmPackDelete(id){
            eId = id; 
            deleteCallback = () => {
                 appData.packList = appData.packList.filter(x => x.id !== id);
                 save();
                 renderPackList();
                 closeConfirmModal();
                 eId = null;
            };
            document.getElementById('confirmModal').classList.add('open');
        }

        function executeDelete(){
            if(deleteCallback) deleteCallback();
            closeConfirmModal();
        }

        function closeConfirmModal(){
            document.getElementById('confirmModal').classList.remove('open');
            deleteCallback = null;
        }

        function doDelete(){
            const m=document.getElementById('mMode').value;
            if(m==='plan') appData.schedule=appData.schedule.filter(x=>x.id!==eId);
            else appData.expenses=appData.expenses.filter(x=>x.id!==eId);
            save();
            refresh();
            closeModal();
            closeConfirmModal();
        }

        function showMap(l){
            const searchQ = l + " Hokkaido";
            document.getElementById('dashMapFrame').src=`https://maps.google.com/maps?q=${encodeURIComponent(searchQ)}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
            
            const btn = document.getElementById('mapBtn');
            btn.innerText = "üìç Navigate Here";
            btn.classList.add('nav-mode');
            btn.href = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(l)}`;
            
            document.getElementById('dashInfo').style.display='none';
            document.getElementById('dashMapFrame').style.display='block';
            document.querySelector('.close-map').style.display='block';
        }
        
        function closeMap(){
            document.getElementById('dashInfo').style.display='flex';
            document.getElementById('dashMapFrame').style.display='none';
            document.querySelector('.close-map').style.display='none';
            
            const btn = document.getElementById('mapBtn');
            btn.innerText = "üó∫Ô∏è Open Full Map";
            btn.classList.remove('nav-mode');
            btn.href = "https://maps.app.goo.gl/C7BTdCcFGdUTAscw5";
        }
        
        let eId=null;
        function editEvent(e,id){e.stopPropagation();openModal('plan',appData.schedule.find(x=>x.id===id));}
        function editExp(id){openModal('spend',appData.expenses.find(x=>x.id===id));}
        
        function openModal(m,d){
            document.getElementById('modal').classList.add('open');
            document.getElementById('mMode').value=m;
            
            document.getElementById('fPlan').style.display=m==='plan'?'block':'none';
            document.getElementById('fSpend').style.display=m==='spend'?'block':'none';
            document.getElementById('fPool').style.display=m==='pool'?'block':'none';
            
            document.getElementById('btnDel').style.display = m==='pool' ? 'none' : 'block';

            if(m === 'pool'){
                document.getElementById('mTitle').innerText = "Edit Pool Fund";
                document.getElementById('plHKD').value = appData.poolHKD || 0;
                document.getElementById('plJPY').value = appData.poolJPY || 0;
                eId = null;
                return;
            }

            if(d){
                eId=d.id;
                document.getElementById('mTitle').innerText='Edit';
                if(m==='plan'){
                    document.getElementById('inpStart').value=d.start;
                    document.getElementById('inpEnd').value=d.end;
                    document.getElementById('inpTitle').value=d.title;
                    document.getElementById('inpLoc').value=d.loc;
                } else {
                    document.getElementById('spItem').value=d.item;
                    document.getElementById('spAmt').value=d.amount;
                    document.getElementById('spCurr').value=d.curr;
                    document.getElementById('spCat').value=d.cat;
                    document.getElementById('spPayer').value=d.payer;
                    document.getElementById('spMethod').value=d.method||'Credit Card';
                    document.getElementById('spType').value=d.type||'Group';
                }
            } else {
                eId=null;
                document.getElementById('mTitle').innerText='Add New';
                if(m==='spend') { document.getElementById('spItem').value=''; document.getElementById('spAmt').value=''; }
                if(m==='plan') { document.getElementById('inpTitle').value=''; document.getElementById('inpLoc').value=''; }
            }
        }
        
        function closeModal(){document.getElementById('modal').classList.remove('open');}
        
        function doSave(){
            const m=document.getElementById('mMode').value;
            
            if(m==='pool'){
                appData.poolHKD = parseFloat(document.getElementById('plHKD').value) || 0;
                appData.poolJPY = parseFloat(document.getElementById('plJPY').value) || 0;
                save();
                refresh();
                closeModal();
                return;
            }

            if(m==='plan'){
                const s=document.getElementById('inpStart').value,e=document.getElementById('inpEnd').value,t=document.getElementById('inpTitle').value,l=document.getElementById('inpLoc').value;
                if(eId){
                    const i=appData.schedule.findIndex(x=>x.id===eId);
                    if(i>=0) Object.assign(appData.schedule[i],{start:s,end:e,title:t,loc:l});
                } else {
                    if(!appData.schedule) appData.schedule=[];
                    appData.schedule.push({id:Date.now(),date:appData.currDate,start:s,end:e,title:t,loc:l});
                }
            } else if (m==='spend') {
                const i=document.getElementById('spItem').value,a=parseFloat(document.getElementById('spAmt').value),c=document.getElementById('spCurr').value,ct=document.getElementById('spCat').value,p=document.getElementById('spPayer').value,mt=document.getElementById('spMethod').value,ty=document.getElementById('spType').value;
                if(eId){
                    const ix=appData.expenses.findIndex(x=>x.id===eId);
                    if(ix>=0) Object.assign(appData.expenses[ix],{item:i,amount:a,curr:c,cat:ct,payer:p,method:mt,type:ty});
                } else {
                    if(!appData.expenses) appData.expenses=[];
                    appData.expenses.push({id:Date.now(),item:i,amount:a,curr:c,cat:ct,payer:p,method:mt,type:ty});
                }
            }
            save();
            refresh();
            closeModal();
        }
        
        function clickAdd(){
            const p=document.querySelector('.page.active').id;
            // --- 3. FIX: HIDE + ON PACK TAB ---
            if(p==='pg-pack') {
                // Do nothing
            }
            else openModal(p==='pg-plan'?'plan':'spend',null);
        }
        
        function nav(p){
            document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
            document.getElementById('pg-'+p).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // --- 3. FIX: TOGGLE FAB VISIBILITY ---
            const fab = document.getElementById('mainFab');
            if(p === 'pack') {
                fab.style.display = 'none';
            } else {
                fab.style.display = 'flex';
                fab.innerHTML = '+';
            }
        }
        
        function renderDates(){
            const el=document.getElementById('dateStrip');el.innerHTML='';
            const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            for(let i=8;i<=18;i++){
                const d=`2026-01-${i<10?'0'+i:i}`;const dt=new Date(d);const wk=days[dt.getDay()];
                const div=document.createElement('div');div.className=`date-pill ${appData.currDate===d?'active':''}`;
                div.innerHTML=`<div class="d-wk">${wk} ${i} Jan</div>`;
                div.onclick=()=>{
                    appData.currDate=d; closeMap();
                    refresh();
                };
                el.appendChild(div);
            }
        }
        
        initApp();
    </script>
</body>
</html>



